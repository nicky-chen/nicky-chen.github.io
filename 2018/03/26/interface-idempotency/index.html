<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <script>
        var yiliaConfig = {
            fancybox:  true ,
            animate:  true ,
            isHome: false,
            isPost: false,
            isArchive: true,
            isTag: false,
            isCategory: false,
            open_in_new:  true ,
            rootUrl: "\/"
        };
    </script>

    <title>接口设计的幂等性考虑</title>
    <link rel="icon" href="https://nicky-chen.github.io/img/favicon.ico">

    <link rel="stylesheet" href="https://nicky-chen.github.io/css/style.css">
    <link rel="stylesheet" href="https://nicky-chen.github.io/font-awesome/css/font-awesome.min.css">
    <link rel="apple-touch-icon" href="https://nicky-chen.github.io/apple-touch-icon.png">


    <link rel="stylesheet" href="https://nicky-chen.github.io/fancybox/jquery.fancybox.css">

    
    
    <link rel="stylesheet" href="https://nicky-chen.github.io/highlight/styles/darcula.css">
    <script src="https://nicky-chen.github.io/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>


<body>
<div id="container">
    <div class="left-col">
        <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="https://nicky-chen.github.io/" class="profilepic">
            <img src="https://nicky-chen.github.io/img/avatar.png" class="animated zoomIn js-avatar">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="https://nicky-chen.github.io/">nicky_chin</a></h1>
        </hgroup>

        
        <p class="header-subtitle">I can accept failure,but I can&#39;t accept not trying</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>

                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        

                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>

                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                        <li><a href="https://nicky-chen.github.io/2017/03/17/book_list/" target="_blank">阅读书单</a> </li>
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="https://nicky-chen.github.io/./">主页</a></li>
                        
                            <li><a href="https://nicky-chen.github.io/./tags/">专题分类</a></li>
                        
                            <li><a href="https://nicky-chen.github.io/./post/external/open_source.html">开源项目</a></li>
                        
                            <li><a href="https://nicky-chen.github.io/./post/external/teach_pic.html">技术图谱</a></li>
                        
                            <li><a href="https://nicky-chen.github.io/./post/">归档日志</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="email"><a class="email" target="_blank" href="mailto:shuilianpiying@163.com" title="email"></a></li>
                            
                                <li id="github"><a class="github" target="_blank" href="https://github.com/nicky-chen" title="github"></a></li>
                            
                                <li id="stackoverflow"><a class="stackoverflow" target="_blank" href="https://stackoverflow.com/users/7444060/nicky-chen" title="stackoverflow"></a></li>
                            
                                <li id="简书"><a class="简书" target="_blank" href="https://www.jianshu.com/u/c44ed4847c3d" title="简书"></a></li>
                            
                        </ul>
                    </nav>
                </section>

                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                            <a href="https://nicky-chen.github.io/tags/junit" style="font-size: 12px;" class="color4">Junit</a>
                        
                            <a href="https://nicky-chen.github.io/tags/redis" style="font-size: 12px;" class="color2">Redis</a>
                        
                            <a href="https://nicky-chen.github.io/tags/spring-base" style="font-size: 12px;" class="color3">Spring-Base</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E4%BC%98%E5%8C%96" style="font-size: 12px;" class="color3">优化</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8Fid%E6%96%B9%E6%A1%88" style="font-size: 12px;" class="color4">分布式id方案</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E5%88%9B%E5%BB%BA%E5%9E%8B" style="font-size: 12px;" class="color2">创建型</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E5%9F%BA%E7%A1%80" style="font-size: 12px;" class="color4">基础</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B" style="font-size: 12px;" class="color2">多线程</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE" style="font-size: 12px;" class="color1">思维导图</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" style="font-size: 12px;" class="color4">数据结构</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80" style="font-size: 12px;" class="color1">框架基础</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E6%BA%90%E7%A0%81" style="font-size: 12px;" class="color4">源码</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E7%90%86%E8%AE%BA" style="font-size: 12px;" class="color1">理论</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E7%BB%93%E6%9E%84%E5%9E%8B" style="font-size: 12px;" class="color2">结构型</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E8%A1%8C%E4%B8%BA%E5%9E%8B" style="font-size: 12px;" class="color2">行为型</a>
                        
                            <a href="https://nicky-chen.github.io/tags/%E9%94%81%E4%BC%98%E5%8C%96" style="font-size: 12px;" class="color2">锁优化</a>
                        
                    </div>
                </section>
                

                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/alibaba">alibaba开源项目</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/google">google开源项目</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://nicky-chen.github.io/2017/02/19/tools/">在线工具</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://mysql.taobao.org/monthly/">数据库内核月报</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md">系统设计入门</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://tech.meituan.com/">美团技术团队</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://jm.taobao.org/">阿里中间件团队博客</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">大家好，我叫 陈星，来自杭州。平时喜欢打打球，看看书。 我的人生格言：机会是留给有准备的人的，厚积薄发总归会有收获，沉下心来做事情, 才能一往无前......</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
        <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="https://nicky-chen.github.io/" title="回到主页">nicky_chin</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="https://nicky-chen.github.io/" class="profilepic">
                <img src="https://nicky-chen.github.io/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="https://nicky-chen.github.io/" title="回到主页">nicky_chin</a></h1>
            </hgroup>
            
            <p class="header-subtitle">I can accept failure,but I can&#39;t accept not trying</p>
            
            <nav class="header-menu">
                <ul>
                    
                    <li><a href="https://nicky-chen.github.io/./">主页</a></li>
                    
                    <li><a href="https://nicky-chen.github.io/./tags/">专题分类</a></li>
                    
                    <li><a href="https://nicky-chen.github.io/./post/external/open_source.html">开源项目</a></li>
                    
                    <li><a href="https://nicky-chen.github.io/./post/external/teach_pic.html">技术图谱</a></li>
                    
                    <li><a href="https://nicky-chen.github.io/./post/">归档日志</a></li>
                    
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                            <li id="email"><a class="email" target="_blank" href="mailto:shuilianpiying@163.com" title="email"></a></li>
                            
                            <li id="github"><a class="github" target="_blank" href="https://github.com/nicky-chen" title="github"></a></li>
                            
                            <li id="stackoverflow"><a class="stackoverflow" target="_blank" href="https://stackoverflow.com/users/7444060/nicky-chen" title="stackoverflow"></a></li>
                            
                            <li id="简书"><a class="简书" target="_blank" href="https://www.jianshu.com/u/c44ed4847c3d" title="简书"></a></li>
                            
                        </ul>
            </nav>
        </header>
    </div>
</nav>

        <div class="body-wrap">
            <article id="post-js-android" class="article article-type-post" itemscope="" itemprop="blogPost">

    <div class="article-meta">
        <a href="https://nicky-chen.github.io/2018/03/26/interface-idempotency/" class="article-date">
            <time datetime="2018-03-26 11:18:15 &#43;0800 CST" itemprop="datePublished">2018-03-26</time>
        </a>
    </div>

    <div class="article-inner">
        
        <input type="hidden" class="isFancy">
        

        <header class="article-header">


            <h1 class="article-title" itemprop="name">
                <a class="article-title" href="https://nicky-chen.github.io/2018/03/26/interface-idempotency/">接口设计的幂等性考虑</a>
            </h1>


        </header>

        <div class="article-info article-info-post">

            
            <div class="article-category tagcloud">
                
                <a class="article-category-link" href="https://nicky-chen.github.io/categories/distribution/" style="font-size: 12px;">distribution</a>
                
            </div>
            

            
            <div class="article-tag tagcloud">
                <ul class="article-tag-list">
                    
                    <li class="article-tag-list-item">
                        <a class="article-tag-list-link color1" href="https://nicky-chen.github.io/tags/%e7%90%86%e8%ae%ba/"
                           style="font-size: 12px;">理论</a>
                    </li>
                    
                </ul>
            </div>
            

            <div class="clearfix"></div>
        </div>


        <div class="article-entry" itemprop="articleBody">

            

<h2 id="分布式系统接口幂等性">分布式系统接口幂等性</h2>

<h3 id="1-幂等性定义">1.幂等性定义</h3>

<h4 id="1-1-数学定义">1.1 数学定义</h4>

<blockquote>
<p>在数学里，幂等有两种主要的定义：- 在某二元运算下，幂等元素是指被自己重复运算(或对于函数是为复合)的结果等于它自己的元素。例如，乘法下唯一两个幂等实数为0和1。即 s *s = s- 某一元运算为幂等的时，其作用在任一元素两次后会和其作用一次的结果相同。例如，高斯符号便是幂等的，即f(f(x)) = f(x)。</p>
</blockquote>

<h4 id="1-2-http规范的定义">1.2 HTTP规范的定义</h4>

<p>在HTTP/1.1规范中幂等性的定义是：</p>

<blockquote>
<p>A request method is considered &ldquo;idempotent&rdquo; if the intended effect on the server of multiple identical requests with that method is the same as the effect for a single such request. Of the request methods defined by this specification, PUT, DELETE, and safe request methods are idempotent.</p>
</blockquote>

<p>HTTP的幂等性指的是一次和多次请求某一个资源应该具有相同的副作用。如通过PUT接口将数据的Status置为1，无论是第一次执行还是多次执行，获取到的结果应该是相同的，即执行完成之后Status =1。</p>

<h3 id="2-何种接口提供幂等性">2. 何种接口提供幂等性</h3>

<h4 id="2-1-http支持幂等性的接口">2.1 HTTP支持幂等性的接口</h4>

<p>在HTTP规范中定义GET,PUT和DELETE方法应该具有幂等性。</p>

<ul>
<li>GET方法</li>
</ul>

<blockquote>
<p>The GET method requests transfer of a current selected representation for the target resource,GET is the primary mechanism of information retrieval and the focus of almost all performance optimizations. Hence, when people speak of retrieving some identifiable information via HTTP, they are generally referring to making a GET request.</p>
</blockquote>

<p>GET方法是向服务器查询，不会对系统产生副作用，具有幂等性（不代表每次请求都是相同的结果)</p>

<ul>
<li>PUT方法</li>
</ul>

<blockquote>
<p>The PUT method requests that the state of the target resource be created or replaced with the state defined by the representation enclosed in the request message payload.</p>
</blockquote>

<p>也就是说PUT方法首先判断系统中是否有相关的记录，如果有记录则更新该记录，如果没有则新增记录。</p>

<ul>
<li>DELETE 方法</li>
</ul>

<blockquote>
<p>The DELETE method requests that the origin server remove the association between the target resource and its current functionality. In effect, this method is similar to the rm command in UNIX: it expresses a deletion operation on the URI mapping of the origin server rather than an expectation that the previously associated information be deleted.</p>
</blockquote>

<p>DELETE方法是删除服务器上的相关记录。</p>

<h4 id="2-2-实际业务">2.2 实际业务</h4>

<p>现在简化为这样一个系统，用户购买商品的订单系统与支付系统；订单系统负责记录用户的购买记录已经订单的流转状态（orderStatus),支付系统用于付款，提供</p>

<pre><code>boolean pay(int accountid,BigDecimal amount) //用于付款，扣除用户的
</code></pre>

<p>接口，订单系统与支付系统通过分布式网络交互。
<img src="https://upload-images.jianshu.io/upload_images/10175660-8632b12e6219b2c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="订单幂等性" /></p>

<p>这种情况下，支付系统已经扣款，但是订单系统因为网络原因，没有获取到确切的结果，因此订单系统需要重试。由上图可见，支付系统并没有做到接口的幂等性，订单系统第一次调用和第二次调用，用户分别被扣了两次钱，不符合幂等性原则（同一个订单，无论是调用了多少次，用户都只会扣款一次）。如果需要支持幂等性，付款接口需要修改为以下接口：</p>

<pre><code>boolean pay(int orderId,int accountId,BigDecimal amount)
</code></pre>

<p>通过orderId来标定订单的唯一性，付款系统只要检测到订单已经支付过，则第二次调用不会扣款而会直接返回结果：</p>

<p><img src="https://upload-images.jianshu.io/upload_images/10175660-2309fde4f12eee56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="订单支持幂等" /></p>

<p>在不同的业务中不同接口需要有不同的幂等性，特别是在分布式系统中，因为网络原因而未能得到确定的结果，往往需要支持接口幂等性。</p>

<h3 id="3-分布式系统接口幂等性">3.分布式系统接口幂等性</h3>

<p>随着分布式系统及微服务的普及，因为网络原因而导致调用系统未能获取到确切的结果从而导致重试，这就需要被调用系统具有幂等性。例如上文所阐述的支付系统，针对同一个订单保证支付的幂等性，一旦订单的支付状态确定之后，以后的操作都会返回相同的结果，对用户的扣款也只会有一次。这种接口的幂等性，简化到数据层面的操作：</p>

<pre><code>update userAmount set amount =  'value' ,paystatus = 'paid' where orderId= 'orderid' and paystatus = 'unpay'
</code></pre>

<p>其中value是用户要减少的订单，paystatus代表支付状态，paid代表已经支付，unpay代表未支付，orderid是订单号。在上文中提到的订单系统，订单具有自己的状态（orderStatus),订单状态存在一定的流转。订单首先有提交（0），付款中（1），付款成功（2），付款失败（3），简化之后其流转路径如图：
<img src="https://upload-images.jianshu.io/upload_images/10175660-c68743a6b0945bd1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="订单状态流转的幂等性" /></p>

<p>当orderStatus = 1 时，其前置状态只能是0，也就是说将orderStatus由0-&gt;1 是需要幂等性的</p>

<pre><code>update Order set orderStatus = 1 where OrderId = 'orderid' and orderStatus = 0
</code></pre>

<p>当orderStatus 处于0，1两种状态时，对订单执行0-&gt;1 的状态流转操作应该是具有幂等性的。这时候需要在执行update操作之前检测orderStatus是否已经=1，如果已经=1则直接返回true即可。</p>

<p>但是如果此时orderStatus = 2,再进行订单状态0-&gt;1 时操作就无法成功，但是幂等性是针对同一个请求的，也就是针对同一个requestid保持幂等。</p>

<p>这时候再执行</p>

<pre><code>update Order set orderStatus = 1 where OrderId = 'orderid' and orderStatus = 0
</code></pre>

<p>接口会返回失败，系统没有产生修改，如果再发一次，requestid是相同的，对系统同样没有产生修改。</p>

<h3 id="4-解决方案">4.解决方案</h3>

<p>在微服务架构下，我们在完成一个订单流程时经常遇到下面的场景：</p>

<blockquote>
<ol>
<li>一个订单创建接口，第一次调用超时了，然后调用方重试了一次</li>
<li>在订单创建时，我们需要去扣减库存，这时接口发生了超时，调用方重试了一次</li>
<li>当这笔订单开始支付，在支付请求发出之后，在服务端发生了扣钱操作，接口响应超时了，调用方重试了一次</li>
<li>一个订单状态更新接口，调用方连续发送了两个消息，一个是已创建，一个是已付款。但是你先接收到已付款，然后又接收到了已创建</li>
<li>在支付完成订单之后，需要发送一条短信，当一台机器接收到短信发送的消息之后，处理较慢。消息中间件又把消息投递给另外一台机器处理</li>
</ol>
</blockquote>

<p>以上问题，就是在单体架构转成微服务架构之后，带来的问题。当然不是说单体架构下没有这些问题，在单体架构下同样要避免重复请求。但是出现的问题要比这少得多。</p>

<p>为了解决以上问题，就需要保证接口的幂等性，接口的幂等性实际上就是<strong>接口可重复调用，在调用方多次调用的情况下，接口最终得到的结果是一致的</strong>。有些接口可以天然的实现幂等性，比如查询接口，对于查询来说，你查询一次和两次，对于系统来说，没有任何影响，查出的结果也是一样。</p>

<p>除了查询功能具有天然的幂等性之外，增加、更新、删除都要保证幂等性。那么如何来保证幂等性呢？</p>

<h3 id="全局唯一id">全局唯一ID</h3>

<p>如果使用全局唯一ID，就是根据业务的操作和内容生成一个全局ID，在执行操作前先根据这个全局唯一ID是否存在，来判断这个操作是否已经执行。如果不存在则把全局ID，存储到存储系统中，比如数据库、redis等。如果存在则表示该方法已经执行。</p>

<p>从工程的角度来说，使用全局ID做幂等可以作为一个业务的基础的微服务存在，在很多的微服务中都会用到这样的服务，在每个微服务中都完成这样的功能，会存在工作量重复。另外打造一个高可靠的幂等服务还需要考虑很多问题，比如一台机器虽然把全局ID先写入了存储，但是在写入之后挂了，这就需要引入全局ID的超时机制。</p>

<p>使用全局唯一ID是一个通用方案，可以支持插入、更新、删除业务操作。但是这个方案看起来很美但是实现起来比较麻烦，下面的方案适用于特定的场景，但是实现起来比较简单。</p>

<h3 id="去重表">去重表</h3>

<p>这种方法适用于在业务中有唯一标的插入场景中，比如在以上的支付场景中，如果一个订单只会支付一次，所以订单ID可以作为唯一标识。这时，我们就可以建一张去重表，并且把唯一标识作为唯一索引，在我们实现时，把创建支付单据和写入去去重表，放在一个事务中，如果重复创建，数据库会抛出唯一约束异常，操作就会回滚。</p>

<h3 id="插入或更新">插入或更新</h3>

<p>这种方法插入并且有唯一索引的情况，比如我们要关联商品品类，其中商品的ID和品类的ID可以构成唯一索引，并且在数据表中也增加了唯一索引。这时就可以使用InsertOrUpdate操作。在mysql数据库中如下：</p>

<pre><code>insert into goods_category (goods_id,category_id,create_time,update_time) 
       values(#{goodsId},#{categoryId},now(),now()) 
       on DUPLICATE KEY UPDATE
       update_time=now()
</code></pre>

<h3 id="多版本控制">多版本控制</h3>

<p>这种方法适合在更新的场景中，比如我们要更新商品的名字，这时我们就可以在更新的接口中增加一个版本号，来做幂等</p>

<pre><code>boolean updateGoodsName(int id,String newName,int version);
</code></pre>

<p>在实现时可以如下</p>

<pre><code>update goods set name=#{newName},version=#{version} where id=#{id} and version&lt;${version}
</code></pre>

<h3 id="状态机控制">状态机控制</h3>

<p>这种方法适合在有状态机流转的情况下，比如就会订单的创建和付款，订单的付款肯定是在之前，这时我们可以通过在设计状态字段时，使用int类型，并且通过值类型的大小来做幂等，比如订单的创建为0，付款成功为100。付款失败为99</p>

<p>在做状态机更新时，我们就这可以这样控制</p>

<pre><code>update `order` set status=#{status} where id=#{id} and status&lt;#{status}
</code></pre>

<p>以上就是保证接口幂等性的一些方法。</p>

<h3 id="references">References</h3>

<p><a href="http://blog.brucefeng.info/post/api-idempotent">分布式系统接口幂等性</a></p>


        </div>

    </div>

    
    <nav id="article-nav">

        
        <div id="article-nav-newer" class="article-nav-title">
            <a href="https://nicky-chen.github.io/2018/03/28/decorator/">
                实际项目运用之Decorator模式（装饰器模式）
            </a>
        </div>
        

        
        <div id="article-nav-older" class="article-nav-title">
            <a href="https://nicky-chen.github.io/2018/03/21/binary-operation/">
                java中位运算技巧
            </a>
        </div>
        

    </nav>
    


</article>

<div id="toc" class="toc-article" >
    <strong class="toc-title">文章目录</strong>
    <ol class="toc">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#分布式系统接口幂等性">分布式系统接口幂等性</a>
<ul>
<li><a href="#1-幂等性定义">1.幂等性定义</a>
<ul>
<li><a href="#1-1-数学定义">1.1 数学定义</a></li>
<li><a href="#1-2-http规范的定义">1.2 HTTP规范的定义</a></li>
</ul></li>
<li><a href="#2-何种接口提供幂等性">2. 何种接口提供幂等性</a>
<ul>
<li><a href="#2-1-http支持幂等性的接口">2.1 HTTP支持幂等性的接口</a></li>
<li><a href="#2-2-实际业务">2.2 实际业务</a></li>
</ul></li>
<li><a href="#3-分布式系统接口幂等性">3.分布式系统接口幂等性</a></li>
<li><a href="#4-解决方案">4.解决方案</a></li>
<li><a href="#全局唯一id">全局唯一ID</a></li>
<li><a href="#去重表">去重表</a></li>
<li><a href="#插入或更新">插入或更新</a></li>
<li><a href="#多版本控制">多版本控制</a></li>
<li><a href="#状态机控制">状态机控制</a></li>
<li><a href="#references">References</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </ol>
</div>
<style>
    
    .left-col .switch-btn {
        display: none;
    }

    .left-col .switch-area {
        display: none;
    }
    


</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录" >

<script src="//7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function () {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    
    
    
        
    
</script>


<div class="share">
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a class="bds_qzone" data-cmd="qzone" href="#" title="分享到 QQ 空间"></a>
        <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
        <a class="bds_count" data-cmd="count"></a>
        <a class="bds_more" data-cmd="more"></a>

    </div>
    <script>
        window._bd_share_config = {
            "common": {
                "bdSnsKey": {},
                "bdText": "",
                "bdMini": "2",
                "bdMiniList": false,
                "bdPic": "",
                "bdStyle": "0",
                "bdSize": "24"
            }, "share": {}
        };
        with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = '/static/api/js/share.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</div>




<div style="margin-left: 30px;margin-right: 30px;background: white;padding-left: 30px;padding-right: 30px">
    <div class="comments">
        <h3>COMMENTS</h3>
        <script type="text/javascript">
            (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://nicky-chen.disqus.com/embed.js';
                dsq.setAttribute('data-timestamp', +new Date());
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <div id="disqus_thread"></div>

    </div>
</div>







<div class="scroll" id="post-nav-button">

    
    <a href="https://nicky-chen.github.io/2018/03/28/decorator/" title="上一篇: 实际项目运用之Decorator模式（装饰器模式）">
        <i class="fa fa-angle-left"></i>
    </a>
    


    <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>


    
    <a href="https://nicky-chen.github.io/2018/03/21/binary-operation/" title="下一篇: java中位运算技巧">
        <i class="fa fa-angle-right"></i>
    </a>
    

</div>


<ul class="post-list toc-article">
    
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2019/05/03/apt_lombok_implement/" target="_blank">基于APT(注解处理器)实现Lombok的@getter @setter @toString功能</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/12/19/state-machine/" target="_blank">实际项目运用之State模式（状态模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/11/17/btree-info/" target="_blank">数据结构之BTree和B&#43;Tree(多路平衡查找树 )</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/10/15/id-redis/" target="_blank">分布式全局序列ID方案之Redis优化方案</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/09/25/id-flicker/" target="_blank">分布式全局序列ID方案之Flicker优化方案</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/09/19/id-snowflake/" target="_blank">分布式全局序列ID方案之Snowflake算法</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/25/spring-springmvc/" target="_blank">Spring之动手实现SpringMVC功能</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/22/java-methodhandler/" target="_blank">Java反射优化之方法句柄</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/16/spring-bean-ioc/" target="_blank">Spring之动手实现IOC功能</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/12/spring-bean-lifecycle/" target="_blank">Spring之Bean加载-解析-生命周期</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/09/aqs-condition/" target="_blank">并发基础之Condition(等待队列)</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/07/cache-redis-optimize/" target="_blank">Redis注意事项及常见优化</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/04/aqs_chapter02/" target="_blank">并发基础之AQS同步器（二）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/08/01/cache-redis-slowlog/" target="_blank">Redis之慢查询日志</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/07/31/aqs_chapter01/" target="_blank">并发基础之AQS同步器（一）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/07/16/junit-codeanalysis/" target="_blank">初窥门径之JUnit源码分析</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/07/13/java-securitymanager/" target="_blank">Java安全之SecurityManager</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/07/05/spi-introduction/" target="_blank">框架基础之SPI机制</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/29/responsibility-chain/" target="_blank">实际项目运用之Responsibility-Chain模式（责任链模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/25/jndi-introdution/" target="_blank">JNDI知识摘要</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/17/architect/" target="_blank">技术图谱</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/13/distribution-knowledge/" target="_blank">分布式项目知识要点</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/07/singletion/" target="_blank">设计模式之单例模式终极版【克隆-序列化-反射】</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/06/02/fail-fast-safe/" target="_blank">Fail-Fast和Fail-Safe机制</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/27/adapter/" target="_blank">实际项目运用之Adapter模式（适配器模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/18/template/" target="_blank">设计模式之Template模式（模版模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/14/synchronized-principle/" target="_blank">synchronized实现原理及锁优化</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/13/juc-tree-info/" target="_blank">JUC知识点总结</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/06/strategy/" target="_blank">实际项目运用之Strategy模式（策略模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/05/04/volatile-feature/" target="_blank">volatile关键字原理实现及应用</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/28/high-event/" target="_blank">MYSQL高级特性之【Event事件】</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/27/process-fun/" target="_blank">MYSQL高级特性之【存储过程与函数】</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/25/cap-base-flp/" target="_blank">分布式之【CAP理论、BASE理论 、FLP不可能定理】</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/21/string-builder-question/" target="_blank">字符串拼接的疑惑</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/17/exception-introduce/" target="_blank">Java异常处理-原理及优化建议</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/04/03/thread-jmm-happens-before/" target="_blank">java内存模型之[JMM][重排序][happens-before]</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/28/decorator/" target="_blank">实际项目运用之Decorator模式（装饰器模式）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/26/interface-idempotency/" target="_blank">接口设计的幂等性考虑</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/21/binary-operation/" target="_blank">java中位运算技巧</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/20/classloader-chapter02/" target="_blank">ClassLoader类加载分析（二）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/13/introspector/" target="_blank">Java 内省(Introspector)</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2018/03/08/classloader-chapter01/" target="_blank">ClassLoader类加载分析（一）</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/12/19/builder/" target="_blank">设计模式之builder模式</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/12/07/builder-factory/" target="_blank">设计模式之factory模式</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/11/03/recursive-lock/" target="_blank">可重入锁</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/09/12/show-global-status/" target="_blank">库级优化之SHOW GLOBAL STATUS</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/06/13/optimize-picture/" target="_blank">后端开发需要了解的mysql优化方向</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/05/16/thread-communication/" target="_blank">多线程之线程通信摘要</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/05/07/design-rule/" target="_blank">数据库设计三范式和反范式</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/03/17/book_list/" target="_blank">阅读书单</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/02/19/open_source/" target="_blank">开源项目</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/02/19/tools/" target="_blank">在线工具</a></li>
    
    <li class="post-list-item"><a class="post-list-link" href="https://nicky-chen.github.io/2017/01/23/externalizable-interface/" target="_blank">自定义序列化之Externalizable接口</a></li>
    
</ul>

<script src="//7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    $(".post-list").addClass("toc-article");
    $(".post-list-item a").attr("target", "_blank");
    $("#post-nav-button > a:nth-child(2)").click(function () {
        $(".fa-bars, .fa-times").toggle();
        $(".post-list").toggle(300);
        if ($(".toc").length > 0) {
            $("#toc, #tocButton").toggle(200, function () {
                if ($(".switch-area").is(":visible")) {
                    $("#toc, .switch-btn, .switch-area").toggle();
                    $("#tocButton").attr("value", valueHide);
                }
            })
        }
        else {
            $(".switch-btn, .switch-area").fadeToggle(300);
        }
    })
</script>


<script>

</script>


        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 nicky_chin
            </div>
            <div class="footer-right">
                <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Hugo Theme </a>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数:
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量:
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script src="https://nicky-chen.github.io/js/GithubRepoWidget.js"></script>
<script src="//7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="https://nicky-chen.github.io/js/main.js"></script>


    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum =  5 ;
                var backgroundimg = "url(\/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-119892182-1', 'auto');
ga('send', 'pageview');

</script>






<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>




<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

</div>
</body>
</html>
