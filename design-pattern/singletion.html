<!DOCTYPE html>
<html lang="zh">
<head>

        <title>设计模式之单例模式终极版【克隆-序列化-反射】</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 RSS Feed" />
        <link href="/feeds/design-pattern.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 Categories RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/pygment.css" />
        <link rel="shortcut icon" href="/theme/images/favicon.ico">

        <script src="/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">

    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="/">南乡清水 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

                <ul class="columns">
                    <li><a href="/">首页</a></li>

                    <li
><a href="/yue-du-shu-dan.html">阅读书单</a></li>
                    <li
><a href="/zai-xian-gong-ju.html">在线工具</a></li>
                    <li
><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>
                    <li
><a href="/ji-zhu-tu-pu.html">技术图谱</a></li>
                    <li
><a href="/guan-yu-wo.html">关于我</a></li>
                     <li><a href="/archives.html"><i class="active"></i>归档日志</a></li>
                    <form class="navbar-search pull-right" action="/search.html">
                        <input type="text" class="search-query" placeholder="站内搜" name="q" id="s">
                    </form>
                </ul>
            </div>


<section id="content" class="body">

   <div class="row">

<div id="toc" class="threes columns" style="font-size: 65%">
    <br>
    <h4 style="font-size: 1rem">文章目录</h4>
</div>        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="/design-pattern/singletion.html" rel="bookmark"
                   title="Permalink to 设计模式之单例模式终极版【克隆-序列化-反射】">设计模式之单例模式终极版【克隆-序列化-反射】</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2018-06-07T22:15:00+08:00">
                周四 07 六月 2018
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="/author/nicky_chin.html"> nicky_chin</a>
              </address>
            </footer><!-- /.post-info -->
            <div id="contents" class="entry-content">
              <h1>1 基本内容</h1>
<h3>1.1 概念</h3>
<p>单例模式，是指在任何时候，该类只能被实例化一次，在任何时候，访问该类的对象，对象都是同一个。只要是程序员都会使用到，甚至都不能算是设计模式。但是在我们使用中也需要了解一下单例特性和使用场景</p>
<h3>1.2 模式优缺点</h3>
<p>单例模式有以下优点：</p>
<blockquote>
<p>使用单例模式可以严格的控制用户怎样以及如何访问它
节约系统资源，提高系统的性能</p>
</blockquote>
<p>单例模式有以下缺点：</p>
<blockquote>
<p>不易扩展
单例类职责过重，在一定程度上违背了“单一职责原则”
如实例化对象长时间未使用，会GC回收，导致对象状态的丢失</p>
</blockquote>
<p>#2 单例模式分类</p>
<h3>2.1 饿汉模式</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonEHan</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nf">SingletonEHan</span><span class="o">()</span> <span class="o">{}</span>

    <span class="cm">/**</span>
<span class="cm">     * 1.单例模式的饿汉式</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SingletonEHan</span> <span class="n">singletonEHan</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonEHan</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonEHan</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">singletonEHan</span><span class="o">;</span>
    <span class="o">}</span>

<span class="c1">//     SingletonEHan instance= SingletonEHan.getInstance();</span>

    <span class="cm">/**</span>
<span class="cm">     * 2. 单例模式的饿汉式变换写法</span>
<span class="cm">     * 基本没区别</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SingletonEHan</span> <span class="n">singletonEHanTwo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">singletonEHanTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonEHan</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonEHan</span> <span class="nf">getSingletonEHan</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">singletonEHanTwo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">singletonEHanTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonEHan</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">singletonEHanTwo</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//     SingletonEHan instance= SingletonEHan.getSingletonEHan();</span>


<span class="o">}</span>
</pre></div>


<ul>
<li>优点：在类加载的时候就完成了实例化，避免了线程的同步问题</li>
<li>缺点：由于在类加载的时候就实例化了，未懒加载，会造成内存的浪费</li>
</ul>
<h3>2.2 懒汉模式</h3>
<p><strong>2.2.1 DCL双重校验锁</strong></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">singleton</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>优点：线程安全，延迟加载</li>
<li>缺点：使用了synchronized关键字，需要同步获取，影响性能</li>
</ul>
<p><strong>2.2.2 静态内部类</strong></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonIn</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2424536714640756316L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">SingletonIn</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SingletonInHolder</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SingletonIn</span> <span class="n">singletonIn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonIn</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonIn</span> <span class="nf">getSingletonIn</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">SingletonInHolder</span><span class="o">.</span><span class="na">singletonIn</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>  <span class="o">{</span>
        <span class="n">SingletonIn</span> <span class="n">singleton</span> <span class="o">=</span> <span class="n">getSingletonIn</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>优点：静态内部类随着方法调用而被加载，只加载一次，不存在并发问题，所以是线程安全的，延迟加载，效率高,推荐使用</li>
</ul>
<h3>2.3 枚举</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">enum</span> <span class="n">SingletonEnum</span> <span class="o">{</span>

    <span class="n">INSTANCE</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">&quot;i am singleton&quot;</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="n">SingletonEnum</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>大佬喜欢的用法，简单粗暴，其实有很多学问在里面，请看下文就会知道</p>
<h1>3 克隆-序列化-反射对单例的影响</h1>
<p>对象的创建方式有哪几种？ 
四种：<em>new 、克隆、序列化、反射</em>
上面的单例模式使用的都是new创建对象，那么其他三种方式对单例是否有影响呢？</p>
<h3>3.1 克隆对单例的影响</h3>
<p>实现Cloneable 接口，尽管构造函数是私有，但还会创建一个对象。因为clone方法不会调用构造函数，会直接从内存中copy内存区域。所以单例模式的类是不可以实现Cloneable接口</p>
<p>以静态内部类的单例方式做测试</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CloneNotSupportedException</span> <span class="o">{</span>
        <span class="n">SingletonIn</span> <span class="n">singleton</span> <span class="o">=</span> <span class="n">getSingletonIn</span><span class="o">();</span>
        <span class="n">SingletonIn</span> <span class="n">singleton1</span> <span class="o">=</span> <span class="o">(</span><span class="n">SingletonIn</span><span class="o">)</span> <span class="n">singleton</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
        <span class="n">SingletonIn</span> <span class="n">singleton2</span> <span class="o">=</span> <span class="n">getSingletonIn</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton1</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton2</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>


<p>测试结果</p>
<div class="highlight"><pre><span></span>1173230247
856419764
1173230247
</pre></div>


<p>hash值不一样，所以克隆成功了，生成了一个新对象，所以当对象的使用要求单例的时候，切记不可实现<em>cloneable</em>接口</p>
<h3>3.2 序列化对单例的影响</h3>
<p><strong>3.2.1 静态内部类单例反序列化</strong>
如下方式，我们通过序列化反序列化获取对象，观察对象是否还是单例对象</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">SingletonIn</span> <span class="n">singleton</span> <span class="o">=</span> <span class="n">getSingletonIn</span><span class="o">();</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&quot;d:\\single.obj&quot;</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">singleton</span><span class="o">);</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;d:\\single.obj&quot;</span><span class="o">)));</span>
        <span class="n">SingletonIn</span> <span class="n">singleton1</span> <span class="o">=</span> <span class="o">(</span><span class="n">SingletonIn</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton1</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="n">singleton1</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>


<p>控制台打印结果如下：</p>
<div class="highlight"><pre><span></span>312714112
692404036
false
</pre></div>


<p>hash值不一样，获取的对象非同一对象</p>
<p><strong>3.2.2 枚举序列化反序列化</strong></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">SingletonEnum</span> <span class="n">singleton</span> <span class="o">=</span> <span class="n">SingletonEnum</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&quot;d:\\single.obj&quot;</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">singleton</span><span class="o">);</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;d:\\single.obj&quot;</span><span class="o">)));</span>
        <span class="n">SingletonEnum</span> <span class="n">singleton1</span> <span class="o">=</span> <span class="o">(</span><span class="n">SingletonEnum</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton1</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="n">singleton1</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>


<p>打印结果</p>
<div class="highlight"><pre><span></span>2125039532
2125039532
true
</pre></div>


<p>枚举方式，即使序列化反序列化也不会破坏单例</p>
<p><strong>3.2.3 防止序列化对单例的破坏</strong>
自定义实现对象的readResolve()方法可以解决问题</p>
<div class="highlight"><pre><span></span> <span class="kd">private</span> <span class="n">Object</span> <span class="nf">readResolve</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getSingletonIn</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>


<p>打印结果</p>
<div class="highlight"><pre><span></span>312714112
312714112
true
</pre></div>


<p>这样反序列化获取到的就是原有的单例了</p>
<p><strong>3.2.4 原理分析</strong>
debug反序列化方法readObject()，调用链如下：
<img alt="调用链" src="https://upload-images.jianshu.io/upload_images/10175660-d1da63abc447d05a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>主要分析这部分1767行开始 <em>readOrdinaryObject</em> 下面的源码</p>
<div class="highlight"><pre><span></span><span class="c1">//获取SingletonIn的Class</span>
 <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">forClass</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">cl</span> <span class="o">==</span> <span class="n">Class</span><span class="o">.</span><span class="na">class</span>
               <span class="o">||</span> <span class="n">cl</span> <span class="o">==</span> <span class="n">ObjectStreamClass</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidClassException</span><span class="o">(</span><span class="s">&quot;invalid class descriptor&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">Object</span> <span class="n">obj</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span><span class="c1">//如果所代表的类是可序列化或者自定义序列化并且可以序列化runtime时候被实例化，则返回true</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">isInstantiable</span><span class="o">()</span> <span class="o">?</span> <span class="n">desc</span><span class="o">.</span><span class="na">newInstance</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
      <span class="c1">//debug在这里通过反射创建了对象</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//省略</span>
        <span class="o">}</span>

        <span class="n">passHandle</span> <span class="o">=</span> <span class="n">handles</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">unshared</span> <span class="o">?</span> <span class="n">unsharedMarker</span> <span class="o">:</span> <span class="n">obj</span><span class="o">);</span>
        <span class="n">ClassNotFoundException</span> <span class="n">resolveEx</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">getResolveException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resolveEx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handles</span><span class="o">.</span><span class="na">markException</span><span class="o">(</span><span class="n">passHandle</span><span class="o">,</span> <span class="n">resolveEx</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="c1">//是否实现了自定义序列化接口</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">isExternalizable</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">readExternalData</span><span class="o">((</span><span class="n">Externalizable</span><span class="o">)</span> <span class="n">obj</span><span class="o">,</span> <span class="n">desc</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">//读取持久化的数据并写入对象</span>
            <span class="n">readSerialData</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">desc</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">handles</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">passHandle</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;</span> <span class="n">handles</span><span class="o">.</span><span class="na">lookupException</span><span class="o">(</span><span class="n">passHandle</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
            <span class="n">desc</span><span class="o">.</span><span class="na">hasReadResolveMethod</span><span class="o">())</span>
       <span class="c1">//如果所代表对象实现了可序列化或者自定义序列化接口，并且定义了readResolve方法，则返回true</span>
        <span class="o">{</span>
            <span class="c1">//获取readResolve方法中的对象，并替换obj</span>
            <span class="n">Object</span> <span class="n">rep</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">invokeReadResolve</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">unshared</span> <span class="o">&amp;&amp;</span> <span class="n">rep</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">rep</span> <span class="o">=</span> <span class="n">cloneArray</span><span class="o">(</span><span class="n">rep</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">rep</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">handles</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">passHandle</span><span class="o">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">rep</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//返回返序列化对象</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
</pre></div>


<p>从上面源码可知，反序列化的时候，通过反射会创建新的对象，所以不是单例，如果类实现了serializable or externalizable 接口，定义readResolve方法，可以控制最终反序列对象，所以重写该方法，可以实现单例</p>
<p>而如果是枚举类型的话主要关注<em>checkResolve(readEnum(unshared))</em> 方法，readEnum(unshared)返回的对象就是INSTANCE对象</p>
<div class="highlight"><pre><span></span><span class="c1">//获取枚举类对象</span>
 <span class="kd">private</span> <span class="n">Enum</span><span class="o">&lt;?&gt;</span> <span class="n">readEnum</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">unshared</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

      <span class="c1">//分配给给定对象的下一个可用句柄，并分配赋值处理,</span>
        <span class="kt">int</span> <span class="n">enumHandle</span> <span class="o">=</span> <span class="n">handles</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">unshared</span> <span class="o">?</span> <span class="n">unsharedMarker</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">ClassNotFoundException</span> <span class="n">resolveEx</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">getResolveException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resolveEx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handles</span><span class="o">.</span><span class="na">markException</span><span class="o">(</span><span class="n">enumHandle</span><span class="o">,</span> <span class="n">resolveEx</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">readString</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">Enum</span><span class="o">&lt;?&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">//获取枚举类Class</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="na">forClass</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="c1">//方法返回具有指定名称的枚举类型的枚举常量，获取到INSTANCE对象</span>
                <span class="n">Enum</span><span class="o">&lt;?&gt;</span> <span class="n">en</span> <span class="o">=</span> <span class="n">Enum</span><span class="o">.</span><span class="na">valueOf</span><span class="o">((</span><span class="n">Class</span><span class="o">)</span><span class="n">cl</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">en</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
             <span class="c1">// 省略</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">unshared</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">handles</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">enumHandle</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">handles</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">enumHandle</span><span class="o">);</span>
        <span class="n">passHandle</span> <span class="o">=</span> <span class="n">enumHandle</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

<span class="kd">private</span> <span class="n">Object</span> <span class="nf">checkResolve</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
       <span class="c1">//在这一步就返回对象了</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">enableResolve</span> <span class="o">||</span> <span class="n">handles</span><span class="o">.</span><span class="na">lookupException</span><span class="o">(</span><span class="n">passHandle</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Object</span> <span class="n">rep</span> <span class="o">=</span> <span class="n">resolveObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rep</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handles</span><span class="o">.</span><span class="na">setObject</span><span class="o">(</span><span class="n">passHandle</span><span class="o">,</span> <span class="n">rep</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rep</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>


<p>魔法在java.lang.Enum.valueOf()中，最后获取的是常量类</p>
<h3>3.3 反射对单例的影响</h3>
<div class="highlight"><pre><span></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ReflectiveOperationException</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">SingletonIn</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="n">Constructor</span><span class="o">&lt;</span><span class="n">SingletonIn</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">();</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">SingletonIn</span> <span class="n">singleton</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">SingletonIn</span> <span class="n">singleton1</span> <span class="o">=</span> <span class="n">getSingletonIn</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton1</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="n">singleton1</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>


<p>打印结果</p>
<div class="highlight"><pre><span></span>1173230247
856419764
false
</pre></div>


<p>反射直接破坏单例,解决方法是在构造器使用同步块互斥</p>
<div class="highlight"><pre><span></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">SingletonIn</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">init</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&quot;只能单例获取&quot;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">init</span> <span class="o">=</span> <span class="o">!</span><span class="n">init</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>


<p>在这种条件下，再次通过反射调用就会报错：</p>
<div class="highlight"><pre><span></span><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ExceptionInInitializerError</span>
    <span class="n">at</span> <span class="n">designpattern1</span><span class="o">.</span><span class="na">singleton</span><span class="o">.</span><span class="na">inclass</span><span class="o">.</span><span class="na">SingletonIn</span><span class="o">.</span><span class="na">getSingletonIn</span><span class="o">(</span><span class="n">SingletonIn</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">43</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">designpattern1</span><span class="o">.</span><span class="na">singleton</span><span class="o">.</span><span class="na">inclass</span><span class="o">.</span><span class="na">SingletonIn</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">SingletonIn</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">57</span><span class="o">)</span>
<span class="n">Caused</span> <span class="n">by</span><span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="n">只能单例获取</span>
</pre></div>


<h1>4 总结</h1>
<p>枚举类型是绝对单例的，可以无责任使用
其他需根据场景使用不同版本,在有序列化和反射的场景下，选择合适的安全版本</p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "design-pattern/singletion.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://nicky-chen.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns" style="font-size: 80%">


    <nav class="widget">
        <h4>个人链接</h4>
        <ul class="blank">
            <li><a href="https://stackoverflow.com/users/7444060/nicky-chen">StackOverFlow</a></li>
            <li><a href="https://github.com/nicky-chen">个人GitHub</a></li>
            <li><a href="https://www.jianshu.com/u/c44ed4847c3d">简书博客</a></li>
        </ul>
    </nav>

<h4>专题分类</h4>

 <ul>
     <!---->
     <!---->
     <!---->
     <!--<li><a href="/yue-du-shu-dan.html">阅读书单</a></li>-->
     <!---->
     <!--<li><a href="/zai-xian-gong-ju.html">在线工具</a></li>-->
     <!---->
     <!--<li><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>-->
     <!---->
     <!--<li><a href="/ji-zhu-tu-pu.html">技术图谱</a></li>-->
     <!---->
     <!--<li><a href="/guan-yu-wo.html">关于我</a></li>-->
     <!---->
     <!--<li class="divider-vertical"></li>-->
     <!---->

     <li >
         <a href="/algorithm/index.html">
             Algorithm
         </a>
     </li>
     <li >
         <a href="/classloader/index.html">
             Classloader
         </a>
     </li>
     <li >
         <a href="/concurrent/index.html">
             concurrent
         </a>
     </li>
     <li class="active" >
         <a href="/design-pattern/index.html">
             design-pattern
         </a>
     </li>
     <li >
         <a href="/distrubuted/index.html">
             distrubuted
         </a>
     </li>
     <li >
         <a href="/java-base/index.html">
             java-base
         </a>
     </li>
     <li >
         <a href="/mysql/index.html">
             MySql
         </a>
     </li>
     <li >
         <a href="/security/index.html">
             Security
         </a>
     </li>
  </ul>

<!---->
<!--<h4>Categories</h4>-->
<!--<ul class="blank">-->
	<!---->
		<!--<li><a href="/algorithm/index.html">Algorithm</a></li>-->
	<!---->
		<!--<li><a href="/classloader/index.html">Classloader</a></li>-->
	<!---->
		<!--<li><a href="/concurrent/index.html">concurrent</a></li>-->
	<!---->
		<!--<li><a href="/design-pattern/index.html">design-pattern</a></li>-->
	<!---->
		<!--<li><a href="/distrubuted/index.html">distrubuted</a></li>-->
	<!---->
		<!--<li><a href="/java-base/index.html">java-base</a></li>-->
	<!---->
		<!--<li><a href="/mysql/index.html">MySql</a></li>-->
	<!---->
		<!--<li><a href="/security/index.html">Security</a></li>-->
	<!---->
<!--</ul>-->
<!---->


<h4>标签</h4>
	<ul class="blank">
	    <li class="danger label" ><a href="/tag/li-lun.html">理论</a></li>
	    <li class="danger label" ><a href="/tag/chuang-jian-xing.html">创建型</a></li>
	    <li class="danger label" ><a href="/tag/ku-ji-you-hua.html">库级优化</a></li>
	    <li class="danger label" ><a href="/tag/kuang-jia-ji-chu.html">框架基础</a></li>
	    <li class="danger label" ><a href="/tag/fen-bu-shi-idfang-an.html">分布式ID方案</a></li>
	    <li class="danger label" ><a href="/tag/yuan-ma.html">源码</a></li>
	    <li class="danger label" ><a href="/tag/si-wei-dao-tu.html">思维导图</a></li>
	    <li class="danger label" ><a href="/tag/xing-wei-xing.html">行为型</a></li>
	    <li class="danger label" ><a href="/tag/shu-ju-jie-gou.html">数据结构</a></li>
	    <li class="danger label" ><a href="/tag/ji-chu.html">基础</a></li>
	    <li class="danger label" ><a href="/tag/suo-you-hua.html">锁优化</a></li>
	    <li class="danger label" ><a href="/tag/jie-gou-xing.html">结构型</a></li>
</ul>



<!---->
<!--<nav class="widget">-->
  <!--<h4>Social</h4>-->
  <!--<ul class="blank">-->
  <!---->
    <!--<li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>-->
  <!---->
    <!--<li><a href="http://www.spring4all.com/">Spring中文社区</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/alibaba">alibaba开源项目</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/google">google开源项目</a></li>-->
  <!---->
  <!--</ul>-->
<!--</nav>-->
<!---->


</div> </div><!-- /.row -->
  <div class="pagination">★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆
      <ul>
        <li class="prev"><a href="/java-base/fail-fast-safe.html">Next →</a></li>
        <li><a href="/archives.html">博客导航</a></li>
        <li class="next"><a href="/distrubuted/distrubuted-knowledge.html">← Previous</a></li>
      </ul>
    </div>

    <h4>相关文章推荐</h4>
    <ul>
        <li><a href="/design-pattern/builder-factory.html">设计模式之factory模式</a></li>
        <li><a href="/design-pattern/builder.html">设计模式之builder模式</a></li>
    </ul>


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">



                   <address id="about" class="vcard body">
                       <br>
                       <nav class="widget">
                           <h4>推荐博客</h4>
                           <ul class="blank">
                               <li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>
                               <li><a href="http://www.spring4all.com/">Spring中文社区</a></li>
                               <li><a href="https://github.com/alibaba">alibaba开源项目</a></li>
                               <li><a href="https://github.com/google">google开源项目</a></li>
                           </ul>
                       </nav>
                       <br/>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-119892182-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'nicky-chen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="/theme/js/libs/gumby.min.js"></script>
  <script src="/theme/js/plugins.js"></script>
  <script src="/theme/js/toc.js" type="text/javascript"></script>
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</body>
</html>