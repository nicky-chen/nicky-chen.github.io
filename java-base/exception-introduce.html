<!DOCTYPE html>
<html lang="zh">
<head>

        <title>Java异常处理-原理及优化建议</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 RSS Feed" />
        <link href="/feeds/java-base.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 Categories RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/pygment.css" />
        <link rel="shortcut icon" href="/theme/images/favicon.ico">

        <script src="/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="/">南乡清水 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

                <ul class="columns">
                    <li><a href="/">Home</a></li>

                    <li
><a href="/yue-du-shu-dan.html">阅读书单</a></li>
                    <li
><a href="/zai-xian-gong-ju.html">在线工具</a></li>
                    <li
><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>
                    <li
><a href="/guan-yu-wo.html">关于我</a></li>
                     <li><a href="/archives.html"><i class="active"></i>归档日志</a></li>
                    <form class="navbar-search pull-right" action="/search.html">
                        <input type="text" class="search-query" placeholder="站内搜" name="q" id="s">
                    </form>
                </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="/java-base/exception-introduce.html" rel="bookmark"
                   title="Permalink to Java异常处理-原理及优化建议">Java异常处理-原理及优化建议</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2018-04-17T19:00:00+08:00">
                周二 17 四月 2018
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="/author/nicky_chin.html"> nicky_chin</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <h1>1 异常层次结构</h1>
<p>异常指不期而至的各种状况，如：文件找不到、网络连接失败、非法参数等。异常是一个事件，它发生在程序运行期间，干扰了正常的指令流程。Java通 过API中Throwable类的众多子类描述各种不同的异常。因而，Java异常都是对象，是Throwable子类的实例，描述了出现在一段编码中的 错误条件。当条件生成时，错误将引发异常。
      Java异常类层次结构图：
<img alt="Java异常类层次结构图" src="https://upload-images.jianshu.io/upload_images/10175660-248cd3eb6352bfb8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>在 Java 中，所有的异常都有一个共同的祖先 Throwable（可抛出）。Throwable 指定代码中可用异常传播机制通过 Java 应用程序传输的任何问题的共性。
       <strong>Throwable</strong>： 有两个重要的子类：<em>Exception（异常）和 Error（错误）</em>，二者都是 Java 异常处理的重要子类，各自都包含大量子类。
       <strong>Error</strong>（错误）:是程序无法处理的错误，表示运行应用程序中较严重问题。大多数错误与代码编写者执行的操作无关，而表示代码运行时 JVM（Java 虚拟机）出现的问题。例如，Java虚拟机运行错误（Virtual MachineError），当 JVM 不再有继续执行操作所需的内存资源时，将出现 OutOfMemoryError。这些异常发生时，Java虚拟机（JVM）一般会选择线程终止。这些错误表示故障发生于虚拟机自身、或者发生在虚拟机试图执行应用时，如Java虚拟机运行错误（Virtual MachineError）、类定义错误（NoClassDefFoundError）等。这些错误是不可查的，因为它们在应用程序的控制和处理能力之 外，而且绝大多数是程序运行时不允许出现的状况。对于设计合理的应用程序来说，即使确实发生了错误，本质上也不应该试图去处理它所引起的异常状况。在 Java中，错误通过Error的子类描述。</p>
<p><strong>Exception</strong>（异常）:是程序本身可以处理的异常。
Exception 类有一个重要的子类 RuntimeException。RuntimeException 类及其子类表示“JVM 常用操作”引发的错误。例如，若试图使用空值对象引用、除数为零或数组越界，则分别引发运行时异常（NullPointerException、ArithmeticException）和 ArrayIndexOutOfBoundException。</p>
<p>通常，Java的异常(包括Exception和Error)分为可查的异常（checked exceptions）和不可查的异常（unchecked exceptions）。 </p>
<blockquote>
<p>运行时异常：都是RuntimeException类及其子类异常，如NullPointerException(空指针异常)、IndexOutOfBoundsException(下标越界异常)等，这些异常是不检查异常，程序中可以选择捕获处理，也可以不处理。这些异常一般是由程序逻辑错误引起的，程序应该从逻辑角度尽可能避免这类异常的发生。
运行时异常的特点是Java编译器不会检查它，也就是说，当程序中可能出现这类异常，即使没有用try-catch语句捕获它，也没有用throws子句声明抛出它，也会编译通过。</p>
<p>非运行时异常 （编译异常）：是RuntimeException以外的异常，类型上都属于Exception类及其子类。从程序语法角度讲是必须进行处理的异常，如果不处理，程序就不能编译通过。如IOException、SQLException等以及用户自定义的Exception异常，一般情况下不自定义检查异常。</p>
</blockquote>
<h1>2 JVM字节码分析异常处理机制</h1>
<p>我们都知道 try、catch、finally语句块的执行顺序:
<img alt="try-catch-finally 控制流" src="https://upload-images.jianshu.io/upload_images/10175660-0f52d611affd9a6f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>接下来我们从字节码的角度加深对异常机制的理解，
我们先反编译如下代码：</p>
<div class="highlight"><pre><span></span><span class="nt">public</span> <span class="nt">class</span> <span class="nt">FileDemo</span> <span class="p">{</span>

    <span class="err">private</span> <span class="err">static</span> <span class="err">void</span> <span class="err">divideFun(int</span> <span class="err">a,</span> <span class="err">int</span> <span class="err">b)</span> <span class="err">{</span>
        <span class="err">b</span> <span class="err">=</span> <span class="err">a</span> <span class="err">-</span> <span class="err">b</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">public</span> <span class="nt">static</span> <span class="nt">void</span> <span class="nt">main</span><span class="o">(</span><span class="nt">String</span><span class="cp">[]</span> <span class="nt">args</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">int</span> <span class="err">a</span> <span class="err">=</span> <span class="err">1</span><span class="p">;</span>
        <span class="err">int</span> <span class="err">b</span> <span class="err">=</span> <span class="err">3</span><span class="p">;</span>
        <span class="err">try</span> <span class="err">{</span>
            <span class="err">b</span> <span class="err">=</span> <span class="err">a</span> <span class="err">+</span> <span class="err">b</span><span class="p">;</span>
            <span class="err">FilterInputStream</span> <span class="err">filterInputStream</span> <span class="err">=</span> <span class="err">new</span> <span class="err">BufferedInputStream(new</span> <span class="err">FileInputStream(&quot;</span><span class="n">d</span><span class="p">:</span><span class="o">/</span><span class="n">a</span><span class="s2">&quot;));</span>
<span class="s2">        } catch (FileNotFoundException e) {</span>
<span class="s2">            System.out.println(&quot;</span><span class="n">file</span> <span class="n">error</span><span class="err">&quot;</span><span class="p">);</span>
            <span class="err">divideFun(a,</span> <span class="err">b)</span><span class="p">;</span>
        <span class="p">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">RuntimeException</span> <span class="nt">e</span><span class="o">)</span> <span class="p">{</span>
            <span class="err">b</span> <span class="err">=</span> <span class="err">a</span> <span class="err">*</span> <span class="err">b</span><span class="p">;</span>
            <span class="err">throw</span> <span class="err">e</span><span class="p">;</span>
        <span class="p">}</span> <span class="nt">finally</span> <span class="p">{</span>
            <span class="err">a</span> <span class="err">=</span> <span class="err">0</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="err">}</span>

<span class="err">}</span>
</pre></div>


<p>通过命令javap -c .\FileDemo.class 反编译.class文件得到一下输出：</p>
<div class="highlight"><pre><span></span><span class="nt">PS</span> <span class="nt">E</span><span class="o">:</span><span class="err">\</span><span class="nt">totalpalce</span><span class="err">\</span><span class="nt">ContentTest</span><span class="err">\</span><span class="nt">target</span><span class="err">\</span><span class="nt">classes</span><span class="err">\</span><span class="nt">exception</span><span class="o">&gt;</span> <span class="nt">javap</span> <span class="nt">-c</span> <span class="o">.</span><span class="err">\</span><span class="nt">FileDemo</span><span class="p">.</span><span class="nc">class</span>
<span class="nt">Compiled</span> <span class="nt">from</span> <span class="s2">&quot;FileDemo.java&quot;</span>
<span class="nt">public</span> <span class="nt">class</span> <span class="nt">exception</span><span class="p">.</span><span class="nc">FileDemo</span> <span class="p">{</span>
  <span class="err">public</span> <span class="err">exception.FileDemo()</span><span class="p">;</span>
    <span class="n">Code</span><span class="p">:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">aload_0</span>  <span class="o">//</span><span class="err">从局部变量</span><span class="mi">0</span><span class="err">中装载引用类型值</span>
       <span class="mi">1</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="mh">#1</span>  <span class="o">//</span> <span class="n">Method</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">.</span><span class="s2">&quot;&lt;init&gt;&quot;</span><span class="o">:</span><span class="p">()</span><span class="n">V</span> <span class="err">根据编译时类型来调用实例方法</span>
       <span class="mi">4</span><span class="o">:</span> <span class="n">return</span>   <span class="o">//</span><span class="err">从方法中返回，返回值为</span><span class="n">void</span>

  <span class="n">public</span> <span class="kc">static</span> <span class="n">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">java</span><span class="err">.</span><span class="n">lang</span><span class="err">.</span><span class="n">String</span><span class="cp">[]</span><span class="p">);</span>
    <span class="n">Code</span><span class="p">:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">iconst_1</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型常量</span><span class="mi">1</span><span class="err">压入栈</span>
       <span class="mi">1</span><span class="o">:</span> <span class="n">istore_1</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">1</span>  <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="mi">2</span><span class="o">:</span> <span class="n">iconst_3</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型常量</span><span class="mi">3</span><span class="err">压入栈</span>
       <span class="mi">3</span><span class="o">:</span> <span class="n">istore_2</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">2</span>  <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>

       <span class="mi">4</span><span class="o">:</span> <span class="n">iload_1</span>     <span class="o">//</span><span class="err">从局部变量</span><span class="mi">1</span><span class="err">中装载</span><span class="n">int</span><span class="err">类型值</span>  <span class="err">异常语句块</span> <span class="kc">start</span>
       <span class="mi">5</span><span class="o">:</span> <span class="n">iload_2</span>     <span class="o">//</span><span class="err">从局部变量</span><span class="mi">2</span><span class="err">中装载</span><span class="n">int</span><span class="err">类型值</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">iadd</span>        <span class="o">//</span> <span class="err">执行</span><span class="n">int</span><span class="err">类型的加法</span>    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
       <span class="mi">7</span><span class="o">:</span> <span class="n">istore_2</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">2</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
       <span class="mi">8</span><span class="o">:</span> <span class="n">new</span>           <span class="mh">#2</span>   <span class="o">//</span><span class="err">创建一个新对象</span>  <span class="n">class</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">BufferedInputStream</span>
      <span class="mi">11</span><span class="o">:</span> <span class="n">dup</span>         <span class="o">//</span><span class="err">复制栈顶部一个字长内容</span>
      <span class="mi">12</span><span class="o">:</span> <span class="n">new</span>           <span class="mh">#3</span>   <span class="o">//</span> <span class="err">创建一个新对象</span> <span class="n">class</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">FileInputStream</span>
      <span class="mi">15</span><span class="o">:</span> <span class="n">dup</span>         <span class="o">//</span><span class="err">复制栈顶部一个字长内容</span>
      <span class="mi">16</span><span class="o">:</span> <span class="n">ldc</span>           <span class="mh">#4</span>   <span class="o">//</span><span class="err">把常量池中的</span> <span class="s2">&quot;d:/a&quot;</span> <span class="err">压入栈</span>
      <span class="mi">18</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="mh">#5</span>   <span class="o">//</span><span class="err">根据编译时类型来调用实例方法</span> <span class="n">Method</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">FileInputStream</span><span class="o">.</span><span class="s2">&quot;&lt;init&gt;&quot;</span><span class="o">:</span><span class="p">(</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="p">;</span><span class="err">)V</span>
      <span class="err">21:</span> <span class="err">invokespecial</span> <span class="err">#6</span>   <span class="err">//根据编译时类型来调用实例方法</span> <span class="err">Method</span> <span class="err">java/io/BufferedInputStream.&quot;&lt;init&gt;&quot;:(Ljava/io/InputStream</span><span class="p">;</span><span class="err">)V</span>
      <span class="err">24:</span> <span class="err">astore_3</span>    <span class="err">//将引用类型值存入局部变量3</span>
      <span class="err">25:</span> <span class="err">iconst_0</span>    <span class="err">//将int类型常量0压入栈</span>  <span class="err">异常语句块</span> <span class="err">end</span>

      <span class="err">26:</span> <span class="err">istore_1</span>    <span class="err">//将int类型值存入局部变量1</span>  <span class="err">finally语句块</span> <span class="err">a</span> <span class="err">=</span> <span class="err">0</span>
      <span class="err">27:</span> <span class="err">goto</span>          <span class="err">63</span>   <span class="err">//无条件跳转至63</span>

      <span class="err">//碰到</span> <span class="err">FileNotFoundException时，跳到</span> <span class="err">30</span> <span class="err">号指令</span>
      <span class="err">30:</span> <span class="err">astore_3</span>    <span class="err">//将引用类型值存入局部变量3</span>
      <span class="err">31:</span> <span class="err">getstatic</span>     <span class="err">#8</span>   <span class="err">//从类中获取静态字段</span>  <span class="err">Field</span> <span class="err">java/lang/System.</span><span class="n">out</span><span class="p">:</span><span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="p">;</span>
      <span class="err">34:</span> <span class="err">ldc</span>           <span class="err">#9</span>   <span class="err">//</span> <span class="err">把常量池中的&quot;file</span> <span class="err">error&quot;压入栈</span>
      <span class="err">36:</span> <span class="err">invokevirtual</span> <span class="err">#10</span>  <span class="err">//运行时按照对象的类来调用实例方法</span> <span class="err">Method</span> <span class="err">java/io/PrintStream.</span><span class="n">println</span><span class="p">:(</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">String</span><span class="p">;</span><span class="err">)V</span>
      <span class="err">39:</span> <span class="err">iload_1</span>     <span class="err">//从局部变量1中装载int类型值</span>
      <span class="err">40:</span> <span class="err">iload_2</span>     <span class="err">//从局部变量2中装载int类型值</span>
      <span class="err">41:</span> <span class="err">invokestatic</span>  <span class="err">#11</span>  <span class="err">//</span> <span class="err">调用类（静态）方法</span>  <span class="err">Method</span> <span class="n">divideFun</span><span class="p">:(</span><span class="n">II</span><span class="p">)</span><span class="n">V</span>
      <span class="mi">44</span><span class="o">:</span> <span class="n">iconst_0</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型常量</span><span class="mi">0</span><span class="err">压入栈</span>
      <span class="mi">45</span><span class="o">:</span> <span class="n">istore_1</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">1</span> <span class="n">finally</span><span class="err">语句块</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="mi">46</span><span class="o">:</span> <span class="n">goto</span>          <span class="mi">63</span>   <span class="o">//</span><span class="err">无条件跳转至</span><span class="mi">63</span>

      <span class="o">//</span><span class="err">碰到</span> <span class="n">RuntimeException</span><span class="err">时，跳到</span> <span class="mi">49</span> <span class="err">号指令</span>
      <span class="mi">49</span><span class="o">:</span> <span class="n">astore_3</span>    <span class="o">//</span><span class="err">将引用类型值存入局部变量</span><span class="mi">3</span>
      <span class="mi">50</span><span class="o">:</span> <span class="n">iload_1</span>     <span class="o">//</span><span class="err">从局部变量</span><span class="mi">1</span><span class="err">中装载</span><span class="n">int</span><span class="err">类型值</span>
      <span class="mi">51</span><span class="o">:</span> <span class="n">iload_2</span>     <span class="o">//</span><span class="err">从局部变量</span><span class="mi">2</span><span class="err">中装载</span><span class="n">int</span><span class="err">类型值</span>
      <span class="mi">52</span><span class="o">:</span> <span class="n">imul</span>        <span class="o">//</span><span class="err">执行</span><span class="n">int</span><span class="err">类型的乘法</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span>
      <span class="mi">53</span><span class="o">:</span> <span class="n">istore_2</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">2</span>  <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
      <span class="mi">54</span><span class="o">:</span> <span class="n">aload_3</span>     <span class="o">//</span><span class="err">从局部变量</span><span class="mi">3</span><span class="err">中装载引用类型值</span>
      <span class="mi">55</span><span class="o">:</span> <span class="n">athrow</span>      <span class="o">//</span><span class="err">抛出异常或错误</span> <span class="n">throw</span> <span class="n">e</span>

      <span class="o">//</span><span class="err">其他未捕获异常时候，跳到</span> <span class="mi">56</span> <span class="err">号指令</span>
      <span class="mi">56</span><span class="o">:</span> <span class="n">astore</span>        <span class="mi">4</span>  <span class="o">//</span> <span class="err">将引用类型或</span><span class="n">returnAddress</span><span class="err">类型值存入局部变量</span>
      <span class="mi">58</span><span class="o">:</span> <span class="n">iconst_0</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型常量</span><span class="mi">0</span><span class="err">压入栈</span>
      <span class="mi">59</span><span class="o">:</span> <span class="n">istore_1</span>    <span class="o">//</span><span class="err">将</span><span class="n">int</span><span class="err">类型值存入局部变量</span><span class="mi">1</span> <span class="n">finally</span><span class="err">语句块</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="mi">60</span><span class="o">:</span> <span class="n">aload</span>         <span class="mi">4</span>  <span class="o">//</span><span class="err">从局部变量中装载引用类型值（</span><span class="n">refernce</span><span class="err">）</span>
      <span class="mi">62</span><span class="o">:</span> <span class="n">athrow</span>      <span class="o">//</span><span class="err">抛出异常或错误</span>
      <span class="mi">63</span><span class="o">:</span> <span class="n">return</span>      <span class="o">//</span><span class="err">从方法中返回，返回值为</span><span class="n">void</span>
    <span class="n">Exception</span> <span class="kc">table</span><span class="o">:</span>  <span class="o">//</span> <span class="err">异常表</span>
       <span class="n">from</span>    <span class="kc">to</span>  <span class="n">target</span> <span class="n">type</span>
           <span class="mi">4</span>    <span class="mi">25</span>    <span class="mi">30</span>   <span class="n">Class</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">FileNotFoundException</span> <span class="o">//</span><span class="mi">4-25</span><span class="err">号指令中，碰到</span> <span class="n">FileNotFoundException</span><span class="err">时，跳到</span> <span class="mi">30</span> <span class="err">号指令</span>
           <span class="mi">4</span>    <span class="mi">25</span>    <span class="mi">49</span>   <span class="n">Class</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">RuntimeException</span>
           <span class="mi">4</span>    <span class="mi">25</span>    <span class="mi">56</span>   <span class="n">any</span>
          <span class="mi">30</span>    <span class="mi">44</span>    <span class="mi">56</span>   <span class="n">any</span>
          <span class="mi">49</span>    <span class="mi">58</span>    <span class="mi">56</span>   <span class="n">any</span>
</pre></div>


<p>通过以上指令，我们能够理解，生成字节码指令的时候，会有一张异常表，记录发生异常情况，跳转到哪一条指令，捕获的异常会在字节码指令中跟踪 try语句块中的代码，当出现该异常的时候跳转到相应catch内部的语句块和最后的finally语句块，如果出现的异常是我们未捕获的，则会走finally的逻辑，并抛出异常错误返回</p>
<p>为了更好的理解我们可以看下面字节码指令结构图：
<img alt="异常字节码指令图" src="https://upload-images.jianshu.io/upload_images/10175660-f388282f852fc14f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1>3 Java异常处理的一般性建议</h1>
<blockquote>
<p>try-catch-finally 规则 异常处理语句的语法规则：
1)  必须在 try 之后添加 catch 或 finally 块。try 块后可同时接 catch 和 finally 块，但至少有一个块。
2) 必须遵循块顺序：若代码同时使用 catch 和 finally 块，则必须将 catch 块放在 try 块之后。
3) catch 块与相应的异常类的类型相关。
4) 一个 try 块可能有多个 catch 块。若如此，则执行第一个匹配块。即Java虚拟机会把实际抛出的异常对象依次和各个catch代码块声明的异常类型匹配，如果异常对象为某个异常类型或其子类的实例，就执行这个catch代码块，不会再执行其他的 catch代码块
5) 可嵌套 try-catch-finally 结构。
6) 在 try-catch-finally 结构中，可重新抛出异常。
7) 除了下列情况，总将执行 finally 做为结束：JVM 过早终止（调用 System.exit(int)）；在 finally 块中抛出一个未处理的异常；计算机断电、失火、或遭遇病毒攻击。</p>
<p>Throws抛出异常的规则：
1) 如果是不可查异常（unchecked exception），即Error、RuntimeException或它们的子类，那么可以不使用throws关键字来声明要抛出的异常，编译仍能顺利通过，但在运行时会被系统抛出。
2) 必须声明方法可抛出的任何可查异常（checked exception）。即如果一个方法可能出现受可查异常，要么用try-catch语句捕获，要么用throws子句声明将它抛出，否则会导致编译错误
3) 仅当抛出了异常，该方法的调用者才必须处理或者重新抛出该异常。当方法的调用者无力处理该异常的时候，应该继续抛出，而不是囫囵吞枣。
4) 调用方法必须遵循任何可查异常的处理和声明规则。若覆盖一个方法，则不能声明与覆盖方法不同的异常。声明的任何异常必须是被覆盖方法所声明异常的同类或子类。</p>
</blockquote>
<h1>4 异常处理优化</h1>
<h5>4. 1 Java7中IO的异常处理 try-with-resource</h5>
<p>try-with-resources语句是一种声明了一种或多种资源的try语句。资源是指在程序用完了之后必须要关闭的对象。try-with-resources语句保证了每个声明了的资源在语句结束的时候都会被关闭。任何实现了java.lang.AutoCloseable接口的对象，和实现了java.io.Closeable接口的对象，都可以当做资源使用。</p>
<div class="highlight"><pre><span></span><span class="nt">public</span> <span class="nt">class</span> <span class="nt">FileHandlerOptimize</span> <span class="p">{</span>

    <span class="err">private</span> <span class="err">static</span> <span class="err">void</span> <span class="err">printFile()</span> <span class="err">throws</span> <span class="err">IOException</span> <span class="err">{</span>
        <span class="err">InputStream</span> <span class="err">input</span> <span class="err">=</span> <span class="err">null</span><span class="p">;</span>

        <span class="err">try</span> <span class="err">{</span>
            <span class="err">input</span> <span class="err">=</span> <span class="err">new</span> <span class="err">FileInputStream(&quot;</span><span class="n">D</span><span class="p">:</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="s2">&quot;);</span>

<span class="s2">            int data = input.read();</span>
<span class="s2">            while (data != -1) {</span>
<span class="s2">                System.out.print((char) data);</span>
<span class="s2">                data = input.read();</span>
<span class="s2">            }</span>
<span class="s2">        } finally {</span>
<span class="s2">            if (input != null) {</span>
<span class="s2">                input.close();</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    }</span>

<span class="s2">    //单个流关闭</span>
<span class="s2">    private static void printFileJava7() throws IOException {</span>

<span class="s2">        try (FileInputStream input = new FileInputStream(&quot;</span><span class="n">D</span><span class="o">:/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="s2">&quot;)) {</span>

<span class="s2">            int data = input.read();</span>
<span class="s2">            while (data != -1) {</span>
<span class="s2">                System.out.print((char) data);</span>
<span class="s2">                data = input.read();</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    }</span>

<span class="s2">    //如果需要对多个流自动关闭</span>
<span class="s2">    private static void printFileJava7Multiple() throws IOException {</span>
<span class="s2">//你可以在一个try-with-resources语句里面声明多个资源</span>
<span class="s2">        try (FileInputStream input = new FileInputStream(&quot;</span><span class="n">D</span><span class="o">:/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="err">&quot;</span><span class="p">);</span>
                <span class="err">BufferedInputStream</span> <span class="err">bufferedInput</span> <span class="err">=</span> <span class="err">new</span> <span class="err">BufferedInputStream(input))</span> <span class="err">{</span>

            <span class="err">int</span> <span class="err">data</span> <span class="err">=</span> <span class="err">bufferedInput.read()</span><span class="p">;</span>
            <span class="err">while</span> <span class="err">(data</span> <span class="err">!=</span> <span class="err">-1)</span> <span class="err">{</span>
                <span class="err">System.out.print((char)</span> <span class="err">data)</span><span class="p">;</span>
                <span class="err">data</span> <span class="err">=</span> <span class="err">bufferedInput.read()</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="nt">public</span> <span class="nt">static</span> <span class="nt">void</span> <span class="nt">main</span><span class="o">(</span><span class="nt">String</span><span class="cp">[]</span> <span class="nt">args</span><span class="o">)</span> <span class="nt">throws</span> <span class="nt">Exception</span> <span class="p">{</span>
        <span class="err">//单个流处理</span>
        <span class="err">printFileJava7()</span><span class="p">;</span>
        <span class="err">//多个流处理</span>
        <span class="err">printFileJava7Multiple()</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span>
</pre></div>


<p>这是java7的新特性比较简单，但是它做了一定的优化,你反编译.class文件会发现新增了一行代码如下：</p>
<div class="highlight"><pre><span></span>    <span class="nt">private</span> <span class="nt">static</span> <span class="nt">void</span> <span class="nt">printFileJava7</span><span class="o">()</span> <span class="nt">throws</span> <span class="nt">IOException</span> <span class="p">{</span>
        <span class="err">FileInputStream</span> <span class="err">input</span> <span class="err">=</span> <span class="err">new</span> <span class="err">FileInputStream(&quot;</span><span class="n">D</span><span class="p">:</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="err">&quot;</span><span class="p">);</span>
        <span class="err">Throwable</span> <span class="err">var1</span> <span class="err">=</span> <span class="err">null</span><span class="p">;</span>
        <span class="err">try</span> <span class="err">{</span>
            <span class="err">for(int</span> <span class="err">data</span> <span class="err">=</span> <span class="err">input.read()</span><span class="p">;</span> <span class="err">data</span> <span class="err">!=</span> <span class="err">-1</span><span class="p">;</span> <span class="err">data</span> <span class="err">=</span> <span class="err">input.read())</span> <span class="err">{</span>
                <span class="err">System.out.print((char)data)</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="err">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">Throwable</span> <span class="nt">var10</span><span class="o">)</span> <span class="p">{</span>
            <span class="err">var1</span> <span class="err">=</span> <span class="err">var10</span><span class="p">;</span>
            <span class="err">throw</span> <span class="err">var10</span><span class="p">;</span>
        <span class="p">}</span> <span class="nt">finally</span> <span class="p">{</span>
            <span class="err">if</span> <span class="err">(input</span> <span class="err">!=</span> <span class="err">null)</span> <span class="err">{</span>
                <span class="err">if</span> <span class="err">(var1</span> <span class="err">!=</span> <span class="err">null)</span> <span class="err">{</span>
                    <span class="err">try</span> <span class="err">{</span>
                        <span class="err">input.close()</span><span class="p">;</span>
                    <span class="p">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">Throwable</span> <span class="nt">var9</span><span class="o">)</span> <span class="p">{</span>
                        <span class="err">var1.addSuppressed(var9)</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="err">}</span> <span class="nt">else</span> <span class="p">{</span>
                    <span class="err">input.close()</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
</pre></div>


<p>多了 <em>var1.addSuppressed(var9);</em> 这行代码，从Java 1.7开始，大佬们为Throwable类新增了addSuppressed方法，支持将一个异常附加到另一个异常身上，从而当出现两个以上的异常时，避免异常被屏蔽覆盖</p>
<h5>4.2 Java异常处理模板</h5>
<p>对如下代码进行优化：</p>
<div class="highlight"><pre><span></span>    <span class="nt">public</span> <span class="nt">static</span> <span class="nt">void</span> <span class="nt">readFile</span><span class="o">()</span> <span class="nt">throws</span> <span class="nt">IOException</span> <span class="p">{</span>
        <span class="err">byte</span><span class="cp">[]</span> <span class="err">buff</span> <span class="err">=</span> <span class="err">new</span> <span class="err">byte</span><span class="cp">[</span><span class="mi">1024</span><span class="cp">]</span><span class="p">;</span>
        <span class="err">FileInputStream</span> <span class="err">input</span> <span class="err">=</span> <span class="err">null</span><span class="p">;</span>
        <span class="err">try</span> <span class="err">{</span>
            <span class="err">input</span> <span class="err">=</span> <span class="err">new</span> <span class="err">FileInputStream(new</span> <span class="err">File(&quot;</span><span class="n">D</span><span class="p">:</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="err">&quot;</span><span class="p">));</span>
            <span class="err">while</span> <span class="err">(-1</span> <span class="err">!=</span> <span class="err">input.read(buff))</span> <span class="err">{</span>
                <span class="err">System.out.println(new</span> <span class="err">String(buff))</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="err">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">IOException</span> <span class="nt">e</span><span class="o">)</span> <span class="p">{</span>
            <span class="err">e.getMessage()</span><span class="p">;</span>
            <span class="err">throw</span> <span class="err">e</span><span class="p">;</span>
        <span class="p">}</span> <span class="nt">finally</span> <span class="p">{</span>
            <span class="err">if</span> <span class="err">(null</span> <span class="err">!=</span> <span class="err">input)</span> <span class="err">{</span>
                <span class="err">try</span> <span class="err">{</span>
                    <span class="err">input.close()</span><span class="p">;</span>
                <span class="p">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">IOException</span> <span class="nt">e</span><span class="o">)</span> <span class="p">{</span>
                    <span class="err">e.getMessage()</span><span class="p">;</span>
                    <span class="err">throw</span> <span class="err">e</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
</pre></div>


<p>注意: 上面的例子实际上存在异常丢失的隐患, 如果第一个try中出现异常, 接着在执行finally中的input.close()也出现异常, 这时main 方法只能接收到input.close的异常信息, 第一个异常会被覆盖, 导致异常信息丢失</p>
<p>所以正确的写法如下:</p>
<div class="highlight"><pre><span></span><span class="nt">public</span> <span class="nt">class</span> <span class="nt">FileReadDemo</span> <span class="p">{</span>  
    <span class="err">public</span> <span class="err">void</span> <span class="err">readFile()</span> <span class="err">throws</span> <span class="err">ApplicationException</span> <span class="err">{</span>  
        <span class="err">byte</span><span class="cp">[]</span> <span class="err">buff</span> <span class="err">=</span> <span class="err">new</span> <span class="err">byte</span><span class="cp">[</span><span class="mi">1024</span><span class="cp">]</span><span class="p">;</span>  
        <span class="err">IOException</span> <span class="err">processException</span> <span class="err">=</span> <span class="err">null</span><span class="p">;</span>  
        <span class="err">FileInputStream</span> <span class="err">input</span> <span class="err">=</span> <span class="err">null</span><span class="p">;</span>  
        <span class="err">try</span> <span class="err">{</span>  
            <span class="err">input</span> <span class="err">=</span> <span class="err">new</span> <span class="err">FileInputStream(new</span> <span class="err">File(&quot;</span><span class="n">D</span><span class="p">:</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span><span class="s2">&quot;));  </span>
<span class="s2">            while (-1 != input.read(buff)) {  </span>
<span class="s2">                System.out.println(new String(buff));  </span>
<span class="s2">            }  </span>
<span class="s2">        } catch (IOException e) {  </span>
<span class="s2">            processException = e;  </span>
<span class="s2">        } finally {  </span>
<span class="s2">            try {  </span>
<span class="s2">                if(null != input){  </span>
<span class="s2">                    input.close();  </span>
<span class="s2">                }  </span>
<span class="s2">            } catch (IOException e) {  </span>
<span class="s2">                if(null == processException){  </span>
<span class="s2">                    throw new ApplicationException(e);  </span>
<span class="s2">                }else{  </span>
<span class="s2">                    throw new MyException(&quot;</span><span class="n">FileInputStream</span> <span class="n">close</span> <span class="n">exception</span><span class="err">&quot;</span><span class="p">,</span> <span class="n">processException</span><span class="p">);</span>  
                <span class="p">}</span>  
            <span class="err">}</span>  
            <span class="nt">if</span><span class="o">(</span><span class="nt">processException</span> <span class="o">!=</span><span class="nt">null</span><span class="o">)</span><span class="p">{</span>  
                <span class="err">throw</span> <span class="err">new</span> <span class="err">MyException(processException)</span><span class="p">;</span>  
            <span class="p">}</span>  
        <span class="err">}</span>  

    <span class="err">}</span>  

    <span class="nt">public</span> <span class="nt">static</span> <span class="nt">void</span> <span class="nt">main</span><span class="o">(</span><span class="nt">String</span><span class="cp">[]</span> <span class="nt">args</span><span class="o">)</span><span class="p">{</span>  
        <span class="err">try</span> <span class="err">{</span>  
            <span class="err">readFile()</span><span class="p">;</span>  
        <span class="p">}</span> <span class="nt">catch</span> <span class="o">(</span><span class="nt">ApplicationException</span> <span class="nt">e</span><span class="o">)</span> <span class="p">{</span>  
            <span class="err">e.printStackTrace()</span><span class="p">;</span>  
        <span class="p">}</span>  

    <span class="err">}</span>  
<span class="err">}</span>  
</pre></div>


<p>这种写法是不是很糟糕, 我们实际关注的代码就只是第一个try中的四行代码, 这样的缺陷很明显, 一旦系统中有多处地方要用到类似的文件处理操作时, 就需要重复的做try-catch-finally, 很明显, 这就违背了程序开发中的一个重要原则: DRY(Don’t repeat yourself), 代码重复, 不容易阅读和维护, 同时也存在一个隐患, 忘记关闭, 异常没正确处理等, 引入模板方法就可以很好的解决这个问题.</p>
<div class="highlight"><pre><span></span>public class MyException extends RuntimeException {

    public MyException() {
        super();
    }

    public MyException(String message) {
        super(message);
    }

    public MyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyException(Throwable cause, String message) {
        super(message, cause);

    }

    public MyException(Throwable suppressed, Throwable throwable, String message) {
        super(message, throwable);
//多异常覆盖问题
        throwable.addSuppressed(suppressed);
    }

    public MyException(Throwable cause) {
        super(cause);
    }

    protected MyException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}
</pre></div>


<p>提取重复代码</p>
<div class="highlight"><pre><span></span>public abstract class InputStreamProcessingTemplate {

    public void process(String fileName) {
        //防止异常信息丢失
        IOException processException = null;
        InputStream input = null;
        try {
            input = new FileInputStream(fileName);

            doProcess(input);
        } catch (IOException e) {
            processException = e;
        } finally {
            processExceptionHandle(fileName, processException, input);
        }
    }

    //override this method in a subclass, to process the stream.
    public abstract void doProcess(InputStream input) throws IOException;

    private static void processExceptionHandle(String fileName, IOException processException, InputStream input) {
        if (input != null) {
            try {
                input.close();
            } catch (IOException e) {
                if (processException != null) {
                    //防止异常信息丢失
                    throw new MyException(processException, e, &quot;Error message...&quot; + fileName);
                }
                throw new MyException(e, &quot;Error closing InputStream for file &quot; + fileName);
            }
        }
        if (processException != null) {
            throw new MyException(processException, &quot;Error processing InputStream for file &quot; + fileName);
        }
    }
}
</pre></div>


<p>通过这种方式，我们发现我们需要处理逻辑，不需要考虑流的关闭问题</p>
<div class="highlight"><pre><span></span><span class="nt">public</span> <span class="nt">class</span> <span class="nt">Test</span> <span class="p">{</span>

    <span class="err">public</span> <span class="err">static</span> <span class="err">void</span> <span class="err">main(String</span><span class="cp">[]</span> <span class="err">args)</span> <span class="err">{</span>
        <span class="err">new</span> <span class="err">InputStreamProcessingTemplate(){</span>
            <span class="err">@Override</span>
            <span class="err">public</span> <span class="err">void</span> <span class="err">doProcess(InputStream</span> <span class="err">input)</span> <span class="err">throws</span> <span class="err">IOException</span> <span class="err">{</span>
                <span class="err">byte</span><span class="cp">[]</span> <span class="err">buff</span> <span class="err">=</span> <span class="err">new</span> <span class="err">byte</span><span class="cp">[</span><span class="mi">1024</span><span class="cp">]</span><span class="p">;</span>
                <span class="err">while(input.read(buff)</span> <span class="err">!=</span> <span class="err">-1){</span>
                    <span class="err">//do</span> <span class="err">something</span> <span class="err">with</span> <span class="err">the</span> <span class="err">chars...</span>
                    <span class="err">System.out.println(new</span> <span class="err">String(buff))</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="err">}</span>
        <span class="err">}</span><span class="p">.</span><span class="nc">process</span><span class="o">(</span><span class="s2">&quot;D:\\user.txt&quot;</span><span class="o">);</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>


<p>或者使用静态模板方法</p>
<div class="highlight"><pre><span></span>public interface InputStreamProcessor {

    public void process(InputStream input) throws IOException;

}
</pre></div>


<p>静态方法</p>
<div class="highlight"><pre><span></span>public class InputStreamProcessingTemplate {

    public static void process(String fileName, InputStreamProcessor processor) {
        //防止异常信息丢失
        IOException processException = null;
        InputStream input = null;
        try {
            input = new FileInputStream(fileName);
            processor.process(input);
        } catch (IOException e) {
            processException = e;
        } finally {
            processExceptionHandle(fileName, processException, input);

        }
    }

    private static void processExceptionHandle(String fileName, IOException processException, InputStream input) {
        if (input != null) {
            try {
                input.close();
            } catch (IOException e) {
                if (processException != null) {
                    //防止异常信息丢失
                    throw new MyException(processException, e, &quot;Error message...&quot; + fileName);
                }
                throw new MyException(e, &quot;Error closing InputStream for file &quot; + fileName);
            }
        }
        if (processException != null) {
            throw new MyException(processException, &quot;Error processing InputStream for file &quot; + fileName);
        }
    }
}
</pre></div>


<p>这样看上出代码更加简洁优雅</p>
<div class="highlight"><pre><span></span>public class Test {

    public static void main(String[] args) {
        InputStreamProcessingTemplate.process(&quot;D:\\user.txt&quot;, input -&gt; {
            byte[] buff = new byte[1024];
            while(input.read(buff) != -1){
                //do something with the chars...
                System.out.println(new String(buff));
            }
        });
    }
}
</pre></div>


<h5>4.3 java8中的异常简化</h5>
<p>实现 Supplier<T> 提供型接口</p>
<div class="highlight"><pre><span></span>public class MyException extends RuntimeException implements Supplier&lt;RuntimeException&gt; {

    public MyException() {
        super();
    }

    public MyException(String message) {
        super(message);
    }

    public MyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyException(Throwable cause, String message) {
        super(message, cause);

    }

    public MyException(Throwable suppressed, Throwable throwable, String message) {
        super(message, throwable);
        throwable.addSuppressed(suppressed);
    }

    public MyException(Throwable cause) {
        super(cause);
    }

    protected MyException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }

    @Override public RuntimeException get() {
        return this;
    }
</pre></div>


<p>如此我们可以简化我们的NPE判断
原先我们都是这样</p>
<div class="highlight"><pre><span></span>if (user == null) {
            throw new MyException();
        }
if (user.getAge() == null) {
            throw new MyException();
        }
</pre></div>


<p>现在可以这样</p>
<div class="highlight"><pre><span></span><span class="nt">Optional</span><span class="p">.</span><span class="nc">ofNullable</span><span class="o">(</span><span class="nt">Optional</span><span class="p">.</span><span class="nc">ofNullable</span><span class="o">(</span><span class="nt">user</span><span class="o">)</span><span class="p">.</span><span class="nc">orElseThrow</span><span class="o">(</span><span class="nt">MyException</span><span class="p">::</span><span class="nd">new</span><span class="o">)</span><span class="p">.</span><span class="nc">getAge</span><span class="o">())</span><span class="p">.</span><span class="nc">orElseThrow</span><span class="o">(</span><span class="nt">MyException</span><span class="p">::</span><span class="nd">new</span><span class="o">);</span>
</pre></div>


<h5>4.4 异常增强</h5>
<p>我们在平时的软件开发中一般都是进行异常包装，包括其中的 错误码 和 错误信息，
来提示我们程序错误的原因，例如下面例子：</p>
<div class="highlight"><pre><span></span>public void method3() throws EnrichableException{
     try{
        method1(); 
     } catch(EnrichableException e){
        e.addInfo(&quot;An error occurred when trying to ...&quot;);
        throw e;
     }
  }

  public void method2() throws EnrichableException{
     try{
        method1(); 
     } catch(EnrichableException e){
        e.addInfo(&quot;An error occurred when trying to ...&quot;);
        throw e;
     }
  }

  public void method1() throws EnrichableException {
     if(...) throw new EnrichableException(
        &quot;ERROR1&quot;, &quot;Original error message&quot;);   
  }
</pre></div>


<p>方法method1抛出一个异常，通过唯一的错误码标识“ERROR1”。请注意，method1（）被method2（）和method3（）调用。尽管在method1（）方法中，进行了异常信息记录，但是无论在方法method2和method3中运行的时候method1出错，封装的错误结果都是相同的，但是对于开发人员来说，确定是具体是哪一个方法出的问题这可能很重要。错误码“ERROR1”足以确定错误发生在哪里，但不知道在哪个上下文中出现的情况。</p>
<p>解决这个问题的方法是在异常中添加唯一的上下文错误代码，就像添加其他上下文信息一样。这里有一个例子，addInfo（）方法已经被更改以适应以下情况</p>
<div class="highlight"><pre><span></span>public void method3() throws EnrichableException{
     try{
        method1(); 
     } catch(EnrichableException e){
        e.addInfo(&quot;METHOD3&quot;, &quot;ERROR1&quot;,
            &quot;An error occurred when trying to ...&quot;);
        throw e;
     }
  }

  public void method2() throws EnrichableException{
     try{
        method1(); 
     } catch(EnrichableException e){
        e.addInfo(&quot;METHOD2&quot;, &quot;ERROR1&quot;,
            &quot;An error occurred when trying to ...&quot;);
        throw e;
     }
  }

  public void method1() throws EnrichableException {
     if(...) throw new EnrichableException(
        &quot;METHOD1&quot;, &quot;ERROR1&quot;, &quot;Original error message&quot;);   
  }
</pre></div>


<p>这样当method1（）从method3（）调用时，错误标识将如下所显示：</p>
<div class="highlight"><pre><span></span>[METHOD3:ERROR1][METHOD1:ERROR1]
</pre></div>


<p>我们就可以确定方法出错的位置和调用链</p>
<p>而异常增强，则是有这种需求场景的前提下，通过添加异常调用链信息，追踪问题
代码如下：
异常句柄</p>
<div class="highlight"><pre><span></span>public interface ExceptionHandler {

    void handle(String contextCode, String errorCode,
            String errorText, Throwable t);

    void raise(String contextCode, String errorCode,
            String errorText);
}
</pre></div>


<p>异常类</p>
<div class="highlight"><pre><span></span>public class EnrichableException  extends RuntimeException {

    public static final long serialVersionUID = -1;

    private List&lt;InfoItem&gt; infoItems = new ArrayList&lt;&gt;();

    private class InfoItem {

        private String errorContext;

        private String errorCode;

        private String errorText;

        private InfoItem(String contextCode, String errorCode, String errorText) {

            this.errorContext = contextCode;
            this.errorCode = errorCode;
            this.errorText = errorText;
        }
    }

    public EnrichableException(String errorContext, String errorCode, String errorMessage) {

        addInfo(errorContext, errorCode, errorMessage);
    }

    public EnrichableException(String errorContext, String errorCode, String errorMessage, Throwable cause) {
        super(cause);
        addInfo(errorContext, errorCode, errorMessage);
    }

    public EnrichableException addInfo(String errorContext, String errorCode, String errorText) {

        this.infoItems.add(new InfoItem(errorContext, errorCode, errorText));
        return this;
    }

    public String getCode() {
        StringBuilder builder = new StringBuilder();

        for (int i = this.infoItems.size() - 1; i &gt;= 0; i--) {
            InfoItem info = this.infoItems.get(i);
            builder.append(&#39;[&#39;);
            builder.append(info.errorContext);
            builder.append(&#39;:&#39;);
            builder.append(info.errorCode);
            builder.append(&#39;]&#39;);
        }

        return builder.toString();
    }

    @Override public String toString() {
        StringBuilder builder = new StringBuilder();

        builder.append(getCode());
        builder.append(&#39;\n&#39;);

        //append additional context information.
        for (int i = this.infoItems.size() - 1; i &gt;= 0; i--) {
            InfoItem info = this.infoItems.get(i);
            builder.append(&#39;[&#39;);
            builder.append(info.errorContext);
            builder.append(&#39;:&#39;);
            builder.append(info.errorCode);
            builder.append(&#39;]&#39;);
            builder.append(info.errorText);
            if (i &gt; 0) {
                builder.append(&#39;\n&#39;);
            }
        }

        //append root causes and text from this exception first.
        if (getMessage() != null) {
            builder.append(&#39;\n&#39;);
            if (getCause() == null) {
                builder.append(getMessage());
            } else if (!getMessage().equals(getCause().toString())) {
                builder.append(getMessage());
            }
        }
        appendException(builder, getCause());

        return builder.toString();
    }

    private void appendException(StringBuilder builder, Throwable throwable) {
        if (throwable == null) {
            return;
        }
        appendException(builder, throwable.getCause());
        builder.append(throwable.toString());
        builder.append(&#39;\n&#39;);
    }

}
</pre></div>


<p>测试类</p>
<div class="highlight"><pre><span></span>public class ExceptionTest {
    protected ExceptionHandler exceptionHandler = new ExceptionHandler(){
        @Override
        public void handle(String errorContext, String errorCode,
                String errorText, Throwable t){

            if(! (t instanceof EnrichableException)){
                throw new EnrichableException(
                        errorContext, errorCode, errorText, t);
            } else {
                ((EnrichableException) t).addInfo(
                        errorContext, errorCode, errorText);
            }
        }

        @Override
        public void raise(String errorContext, String errorCode,
                String errorText){
            throw new EnrichableException(
                    errorContext, errorCode, errorText);
        }
    };

    public static void main(String[] args){
        ExceptionTest test = new ExceptionTest();
        try{
            test.level1();
        } catch(Exception e){
            e.printStackTrace();
        }
    }

    public void level1(){
        try{
            level2();
        } catch (EnrichableException e){
            this.exceptionHandler.handle(
                    &quot;L1&quot;, &quot;E1&quot;, &quot;Error in level 1, calling level 2&quot;, e);
            throw e;
        }
    }

    public void level2(){
        try{
            level3();
        } catch (EnrichableException e){
            this.exceptionHandler.handle(
                    &quot;L2&quot;, &quot;E2&quot;, &quot;Error in level 2, calling level 3&quot;, e);
            throw e;
        }
    }

    public void level3(){
        try{
            level4();
        } catch(Exception e){
            this.exceptionHandler.handle(
                    &quot;L3&quot;, &quot;E3&quot;, &quot;Error at level 3&quot;, e);
        }
    }

    public void level4(){
        throw new IllegalArgumentException(&quot;incorrect argument passed&quot;);
    }
}
</pre></div>


<p>运行main方法结果如下</p>
<blockquote>
<p>[L1:E1][L2:E2][L3:E3]
[L1:E1]Error in level 1, calling level 2
[L2:E2]Error in level 2, calling level 3
[L3:E3]Error at level 3
java.lang.IllegalArgumentException: incorrect argument passed</p>
</blockquote>
<p>我们可以清晰的定位在哪个流程中函数调用出现了异常</p>
<h1>Reference</h1>
<p><a href="http://tutorials.jenkov.com/java-exception-handling/index.html">Java Exception Handling</a>
<a href="https://unmi.cc/jvm-java-handle-try-catch/">JVM 对 Java 异常的处理原理</a>
<a href="http://ifeve.com/java-exception/">JAVA异常处理</a>
<a href="https://blog.csdn.net/piaohai/article/details/50387238">异常管理 - try-catch-finally异常信息丢失</a>
<a href="http://www.kissyu.org/2016/10/06/深入理解Java%20try-with-resource/?utm_source=tuicool&amp;utm_medium=referral">深入理解Java try-with-resource</a></p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "java-base/exception-introduce.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://nicky-chen.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">


    <nav class="widget">
        <h4>个人链接</h4>
        <ul class="blank">
            <li><a href="https://stackoverflow.com/users/7444060/nicky-chen">StackOverFlow</a></li>
            <li><a href="https://github.com/nicky-chen">个人GitHub</a></li>
            <li><a href="https://www.jianshu.com/u/c44ed4847c3d">简书博客</a></li>
        </ul>
    </nav>

<h4>专题分类</h4>

 <ul>
     <!---->
     <!---->
     <!---->
     <!--<li><a href="/yue-du-shu-dan.html">阅读书单</a></li>-->
     <!---->
     <!--<li><a href="/zai-xian-gong-ju.html">在线工具</a></li>-->
     <!---->
     <!--<li><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>-->
     <!---->
     <!--<li><a href="/guan-yu-wo.html">关于我</a></li>-->
     <!---->
     <!--<li class="divider-vertical"></li>-->
     <!---->

     <li >
         <a href="/algorithm-datastructure/index.html">
             Algorithm-DataStructure
         </a>
     </li>
     <li >
         <a href="/classloader/index.html">
             classloader
         </a>
     </li>
     <li >
         <a href="/concurrent/index.html">
             concurrent
         </a>
     </li>
     <li >
         <a href="/design-pattern/index.html">
             design-pattern
         </a>
     </li>
     <li >
         <a href="/distrubuted/index.html">
             distrubuted
         </a>
     </li>
     <li class="active" >
         <a href="/java-base/index.html">
             java-base
         </a>
     </li>
     <li >
         <a href="/mysql/index.html">
             MySql
         </a>
     </li>
  </ul>

<!---->
<!--<h4>Categories</h4>-->
<!--<ul class="blank">-->
	<!---->
		<!--<li><a href="/algorithm-datastructure/index.html">Algorithm-DataStructure</a></li>-->
	<!---->
		<!--<li><a href="/classloader/index.html">classloader</a></li>-->
	<!---->
		<!--<li><a href="/concurrent/index.html">concurrent</a></li>-->
	<!---->
		<!--<li><a href="/design-pattern/index.html">design-pattern</a></li>-->
	<!---->
		<!--<li><a href="/distrubuted/index.html">distrubuted</a></li>-->
	<!---->
		<!--<li><a href="/java-base/index.html">java-base</a></li>-->
	<!---->
		<!--<li><a href="/mysql/index.html">MySql</a></li>-->
	<!---->
<!--</ul>-->
<!---->


<h4>标签</h4>
	<ul class="blank">
	    <li class="danger label" ><a href="/tag/li-lun.html">理论</a></li>
	    <li class="danger label" ><a href="/tag/chuang-jian-xing.html">创建型</a></li>
	    <li class="danger label" ><a href="/tag/bing-fa-bian-cheng-si-wei-dao-tu.html">并发编程思维导图</a></li>
	    <li class="danger label" ><a href="/tag/ku-ji-you-hua.html">库级优化</a></li>
	    <li class="danger label" ><a href="/tag/shu-ju-jie-gou.html">数据结构</a></li>
	    <li class="danger label" ><a href="/tag/xing-wei-xing.html">行为型</a></li>
	    <li class="danger label" ><a href="/tag/yuan-ma.html">源码</a></li>
	    <li class="danger label" ><a href="/tag/jie-gou-xing.html">结构型</a></li>
	    <li class="danger label" ><a href="/tag/ji-chu.html">基础</a></li>
	    <li class="danger label" ><a href="/tag/mysqlsi-wei-dao-tu.html">mysql思维导图</a></li>
	    <li class="danger label" ><a href="/tag/suo-you-hua.html">锁优化</a></li>
</ul>



<!---->
<!--<nav class="widget">-->
  <!--<h4>Social</h4>-->
  <!--<ul class="blank">-->
  <!---->
    <!--<li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>-->
  <!---->
    <!--<li><a href="http://www.spring4all.com/">Spring中文社区</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/alibaba">alibaba开源项目</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/google">google开源项目</a></li>-->
  <!---->
  <!--</ul>-->
<!--</nav>-->
<!---->


</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">



                   <address id="about" class="vcard body">
                       <br>
                       <nav class="widget">
                           <h4>推荐博客</h4>
                           <ul class="blank">
                               <li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>
                               <li><a href="http://www.spring4all.com/">Spring中文社区</a></li>
                               <li><a href="https://github.com/alibaba">alibaba开源项目</a></li>
                               <li><a href="https://github.com/google">google开源项目</a></li>
                           </ul>
                       </nav>
                       <br/>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-119892182-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'nicky-chen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="/theme/js/libs/gumby.min.js"></script>
  <script src="/theme/js/plugins.js"></script>
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</body>
</html>