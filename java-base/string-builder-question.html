<!DOCTYPE html>
<html lang="zh">
<head>

        <title>字符串拼接的疑惑</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 RSS Feed" />
        <link href="/feeds/java-base.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 Categories RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/pygment.css" />
        <link rel="shortcut icon" href="/theme/images/favicon.ico">

        <script src="/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="/">南乡清水 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

                <ul class="columns">
                    <li><a href="/">Home</a></li>

                    <li
><a href="/yue-du-shu-dan.html">阅读书单</a></li>
                    <li
><a href="/zai-xian-gong-ju.html">在线工具</a></li>
                    <li
><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>
                    <li
><a href="/guan-yu-wo.html">关于我</a></li>
                     <li><a href="/archives.html"><i class="active"></i>归档日志</a></li>
                    <form class="navbar-search pull-right" action="/search.html">
                        <input type="text" class="search-query" placeholder="站内搜" name="q" id="s">
                    </form>
                </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="/java-base/string-builder-question.html" rel="bookmark"
                   title="Permalink to 字符串拼接的疑惑">字符串拼接的疑惑</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2018-04-21T15:34:00+08:00">
                周六 21 四月 2018
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="/author/nicky_chin.html"> nicky_chin</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>最近没事在玩ASM框架，于是乎想将业务代码中的PO对象中的toString方法 在编译期间，自动转换了基于StringBuilder 拼接的代码。发现了一个奇怪的问题：
实体类如下</p>
<div class="highlight"><pre><span></span>@Getter
@Setter
@EqualsAndHashCode(of = &quot;id&quot;)
@ApiModel(&quot;活动&quot;)
public class Banner implements Serializable{

    private static final long serialVersionUID = 191609922585601269L;

    @ApiModelProperty(value = &quot;ID&quot;, position = 1)
    private Integer id;

    @ApiModelProperty(value = &quot;显示次序&quot;, position = 2)
    private Integer orderNo;

    @ApiModelProperty(value = &quot;关联文件&quot;, position = 3)
    private Integer fileId;

    @ApiModelProperty(value = &quot;跳转链接&quot;, position = 4)
    private String forwardLink = &quot;&quot;;

    @ApiModelProperty(value = &quot;创建时间&quot;, position = 5)
    private Long createDateline;

    @ApiModelProperty(value = &quot;是否可用：1 可用，0 不可用&quot;, position = 6)
    private Integer isenable;

    @ApiModelProperty(value = &quot;标题&quot;, position = 7)
    private String title = &quot;&quot;;

    @ApiModelProperty(value = &quot;备注&quot;, position = 8)
    private String remark = &quot;&quot;;

    @ApiModelProperty(value = &quot;banner类型：1.抢单app 2.借款端app&quot;, position = 9)
    private Integer bannerType;

    @ApiModelProperty(value = &quot;图片链接&quot;, position = 10)
    private String url = &quot;&quot;;

    @Override
    public String toString() {
        return &quot;Banner{&quot; + &quot;id=&quot; + id + &quot;, orderNo=&quot; + orderNo + &quot;, fileId=&quot; + fileId + &quot;, forwardLink=&#39;&quot; + forwardLink
                + &#39;\&#39;&#39; + &quot;, createDateline=&quot; + createDateline + &quot;, isenable=&quot; + isenable + &quot;, title=&#39;&quot; + title + &#39;\&#39;&#39;
                + &quot;, remark=&#39;&quot; + remark + &#39;\&#39;&#39; + &quot;, bannerType=&quot; + bannerType + &quot;, url=&#39;&quot; + url + &#39;\&#39;&#39; + &#39;}&#39;;
    }
}
</pre></div>


<p>我的目的是将toString方法变成StringBuilder的方式：</p>
<div class="highlight"><pre><span></span> @Override 
    public String toString() {
        final StringBuilder sb = new StringBuilder(1 &lt;&lt; 8);
        sb.append(&quot;Banner{&quot;);
        sb.append(&quot;id=&quot;).append(id);
        sb.append(&quot;, orderNo=&quot;).append(orderNo);
        sb.append(&quot;, fileId=&quot;).append(fileId);
        sb.append(&quot;, forwardLink=&quot;).append(forwardLink);
        sb.append(&quot;, createDateline=&quot;).append(createDateline);
        sb.append(&quot;, isenable=&quot;).append(isenable);
        sb.append(&quot;, title=&quot;).append(title);
        sb.append(&quot;, remark=&quot;).append(remark);
        sb.append(&quot;, bannerType=&quot;).append(bannerType);
        sb.append(&quot;, url=&quot;).append(url);
        sb.append(&#39;}&#39;);
        return sb.toString();
    }
</pre></div>


<p>我想基于修改字节码来实现它，于是乎我对里了前后两者的字节码差异通过beyondCompare工具比较：
<img alt="tostring.JPG" src="https://upload-images.jianshu.io/upload_images/10175660-09a851593668b527.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
上面红色部分就是ASM解析class文件出来的差异性字节码
可是看第90行代码的时候，突然发现 字符串拼接 + 其底层的实现竟然用的StringBuilder，凌乱了。java编译器做了优化
既然这样为什么大家还建议使用StringBuilder, 直接使用 + 拼接好了么，出于无法理解，我测了下字符串凭借不同方式的效率</p>
<div class="highlight"><pre><span></span>public class Person {

    private String name = &quot;1&quot;;

    private int age = 2;

    @Override
    public String toString() {
        testAdd(100000);
        testConcat(100000);
        testStringBuilder(100000);
        return &quot;&quot;;
    }

    public static void main(String args[]) {
        Person p = new Person();
        p.toString();
    }

    public static void testAdd(int num){
        long start = System.currentTimeMillis();
        String str = &quot;&quot;;
        for(int i = 0; i &lt; num; i++){
            str += i;
        }
        System.out.println(&quot;字符串拼接使用 + 耗时：&quot; + (System.currentTimeMillis() - start) + &quot;ms&quot;);
    }

    public static void testConcat(int num){
        long start = System.currentTimeMillis();
        String str = &quot;&quot;;
        for(int i = 0; i &lt; num; i++){
            str.concat(String.valueOf(i));
        }
        System.out.println(&quot;字符串拼接使用 concat 耗时：&quot; + (System.currentTimeMillis() - start) + &quot;ms&quot;);
    }

    public static void testStringBuffer(int num){
        long start = System.currentTimeMillis();
        StringBuffer stringBuffer = new StringBuffer();
        for(int i = 0; i &lt; num; i++){
            stringBuffer.append(String.valueOf(i));
        }
        stringBuffer.toString();
        System.out.println(&quot;字符串拼接使用 StringBuffer 耗时：&quot; + (System.currentTimeMillis() - start) + &quot;ms&quot;);
    }

    public static void testStringBuilder(int num){
        long start = System.currentTimeMillis();
        StringBuilder stringBuilder = new StringBuilder();
        for(int i = 0; i &lt; num; i++){
            stringBuilder.append(String.valueOf(i));
        }
        stringBuilder.toString();
        System.out.println(&quot;字符串拼接使用 StringBuilder 耗时：&quot; + (System.currentTimeMillis() - start) + &quot;ms&quot;);
    }

}
</pre></div>


<p>代码网上随便copy的，<strong><em>就测试下 +拼接 ， concat拼接， StringBuilder拼接</em></strong>
测试结果让我更疑惑了:</p>
<div class="highlight"><pre><span></span>字符串拼接使用 + 耗时：30117ms
字符串拼接使用 concat 耗时：11ms
字符串拼接使用 StringBuilder 耗时：7ms
</pre></div>


<p>这是在逗我么，既然 + 做了优化这么效率差这么多，编译器开发人员不可能做无用功的,再次看了下字节码</p>
<div class="highlight"><pre><span></span>public static testAdd(I)V
   L0
    LINENUMBER 27 L0
    INVOKESTATIC java/lang/System.currentTimeMillis ()J
    LSTORE 1
   L1
    LINENUMBER 28 L1
    LDC &quot;&quot;
    ASTORE 3
   L2
    LINENUMBER 29 L2
    ICONST_0
    ISTORE 4
   L3
   FRAME APPEND [J java/lang/String I]
    ILOAD 4
    ILOAD 0
    IF_ICMPGE L4
   L5
    LINENUMBER 30 L5
    NEW java/lang/StringBuilder
    DUP
    INVOKESPECIAL java/lang/StringBuilder.&lt;init&gt; ()V
    ALOAD 3
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    ILOAD 4
    INVOKEVIRTUAL java/lang/StringBuilder.append (I)Ljava/lang/StringBuilder;
    INVOKEVIRTUAL java/lang/StringBuilder.toString ()Ljava/lang/String;
    ASTORE 3
   L6
    LINENUMBER 29 L6
    IINC 4 1
    GOTO L3
   L4
    LINENUMBER 32 L4
   FRAME CHOP 1
    GETSTATIC java/lang/System.out : Ljava/io/PrintStream;
    NEW java/lang/StringBuilder
    DUP
    INVOKESPECIAL java/lang/StringBuilder.&lt;init&gt; ()V
    LDC &quot;\u5b57\u7b26\u4e32\u62fc\u63a5\u4f7f\u7528 + \u8017\u65f6\uff1a&quot;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    INVOKESTATIC java/lang/System.currentTimeMillis ()J
    LLOAD 1
    LSUB
    INVOKEVIRTUAL java/lang/StringBuilder.append (J)Ljava/lang/StringBuilder;
    LDC &quot;ms&quot;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    INVOKEVIRTUAL java/lang/StringBuilder.toString ()Ljava/lang/String;
    INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V
   L7
    LINENUMBER 33 L7
    RETURN
   L8
    LOCALVARIABLE i I L3 L4 4
    LOCALVARIABLE num I L0 L8 0
    LOCALVARIABLE start J L1 L8 1
    LOCALVARIABLE str Ljava/lang/String; L2 L8 3
    MAXSTACK = 6
    MAXLOCALS = 5
</pre></div>


<p>发现 + 拼接 每次循环 <strong>GOTO L3</strong>  接下来继续创建在L5环节中new一个StringBuilder不断在生成新的StringBuilder;
而StringBuilder的没有</p>
<div class="highlight"><pre><span></span>public static testStringBuilder(I)V
   L0
    LINENUMBER 55 L0
    INVOKESTATIC java/lang/System.currentTimeMillis ()J
    LSTORE 1
   L1
    LINENUMBER 56 L1
    NEW java/lang/StringBuilder
    DUP
    INVOKESPECIAL java/lang/StringBuilder.&lt;init&gt; ()V
    ASTORE 3
   L2
    LINENUMBER 57 L2
    ICONST_0
    ISTORE 4
   L3
   FRAME APPEND [J java/lang/StringBuilder I]
    ILOAD 4
    ILOAD 0
    IF_ICMPGE L4
   L5
    LINENUMBER 58 L5
    ALOAD 3
    ILOAD 4
    INVOKESTATIC java/lang/String.valueOf (I)Ljava/lang/String;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    POP
   L6
    LINENUMBER 57 L6
    IINC 4 1
    GOTO L3
   L4
    LINENUMBER 60 L4
   FRAME CHOP 1
    ALOAD 3
    INVOKEVIRTUAL java/lang/StringBuilder.toString ()Ljava/lang/String;
    POP
   L7
    LINENUMBER 61 L7
    GETSTATIC java/lang/System.out : Ljava/io/PrintStream;
    NEW java/lang/StringBuilder
    DUP
    INVOKESPECIAL java/lang/StringBuilder.&lt;init&gt; ()V
    LDC &quot;\u5b57\u7b26\u4e32\u62fc\u63a5\u4f7f\u7528 StringBuilder \u8017\u65f6\uff1a&quot;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    INVOKESTATIC java/lang/System.currentTimeMillis ()J
    LLOAD 1
    LSUB
    INVOKEVIRTUAL java/lang/StringBuilder.append (J)Ljava/lang/StringBuilder;
    LDC &quot;ms&quot;
    INVOKEVIRTUAL java/lang/StringBuilder.append (Ljava/lang/String;)Ljava/lang/StringBuilder;
    INVOKEVIRTUAL java/lang/StringBuilder.toString ()Ljava/lang/String;
    INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V
   L8
    LINENUMBER 62 L8
    RETURN
   L9
    LOCALVARIABLE i I L3 L4 4
    LOCALVARIABLE num I L0 L9 0
    LOCALVARIABLE start J L1 L9 1
    LOCALVARIABLE stringBuilder Ljava/lang/StringBuilder; L2 L9 3
    MAXSTACK = 6
    MAXLOCALS = 5
</pre></div>


<p>循环每次  <strong>GOTO L3</strong>  在L3之前已经创建了StringBuilder对象，所以一直使用同一个对象，从而减少GC成本</p>
<p>结论</p>
<blockquote>
<p>因为在编写代码中可能涉及到循环体内的字符串拼接，所以还是建议使用StringBuilder并且要指定初始化容量</p>
</blockquote>
<h1>Reference</h1>
<p><a href="http://bsr1983.iteye.com/blog/1935856">深入分析Java使用+和StringBuilder进行字符串拼接的差异</a></p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "java-base/string-builder-question.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://nicky-chen.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">


    <nav class="widget">
        <h4>个人链接</h4>
        <ul class="blank">
            <li><a href="https://stackoverflow.com/users/7444060/nicky-chen">StackOverFlow</a></li>
            <li><a href="https://github.com/nicky-chen">个人GitHub</a></li>
            <li><a href="https://www.jianshu.com/u/c44ed4847c3d">简书博客</a></li>
        </ul>
    </nav>

<h4>专题分类</h4>

 <ul>
     <!---->
     <!---->
     <!---->
     <!--<li><a href="/yue-du-shu-dan.html">阅读书单</a></li>-->
     <!---->
     <!--<li><a href="/zai-xian-gong-ju.html">在线工具</a></li>-->
     <!---->
     <!--<li><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>-->
     <!---->
     <!--<li><a href="/guan-yu-wo.html">关于我</a></li>-->
     <!---->
     <!--<li class="divider-vertical"></li>-->
     <!---->

     <li >
         <a href="/algorithm-datastructure/index.html">
             Algorithm-DataStructure
         </a>
     </li>
     <li >
         <a href="/classloader/index.html">
             classloader
         </a>
     </li>
     <li >
         <a href="/concurrent/index.html">
             concurrent
         </a>
     </li>
     <li >
         <a href="/design-pattern/index.html">
             design-pattern
         </a>
     </li>
     <li >
         <a href="/distrubuted/index.html">
             distrubuted
         </a>
     </li>
     <li class="active" >
         <a href="/java-base/index.html">
             java-base
         </a>
     </li>
     <li >
         <a href="/mysql/index.html">
             MySql
         </a>
     </li>
  </ul>

<!---->
<!--<h4>Categories</h4>-->
<!--<ul class="blank">-->
	<!---->
		<!--<li><a href="/algorithm-datastructure/index.html">Algorithm-DataStructure</a></li>-->
	<!---->
		<!--<li><a href="/classloader/index.html">classloader</a></li>-->
	<!---->
		<!--<li><a href="/concurrent/index.html">concurrent</a></li>-->
	<!---->
		<!--<li><a href="/design-pattern/index.html">design-pattern</a></li>-->
	<!---->
		<!--<li><a href="/distrubuted/index.html">distrubuted</a></li>-->
	<!---->
		<!--<li><a href="/java-base/index.html">java-base</a></li>-->
	<!---->
		<!--<li><a href="/mysql/index.html">MySql</a></li>-->
	<!---->
<!--</ul>-->
<!---->


<h4>标签</h4>
	<ul class="blank">
	    <li class="danger label" ><a href="/tag/li-lun.html">理论</a></li>
	    <li class="danger label" ><a href="/tag/chuang-jian-xing.html">创建型</a></li>
	    <li class="danger label" ><a href="/tag/bing-fa-bian-cheng-si-wei-dao-tu.html">并发编程思维导图</a></li>
	    <li class="danger label" ><a href="/tag/ku-ji-you-hua.html">库级优化</a></li>
	    <li class="danger label" ><a href="/tag/shu-ju-jie-gou.html">数据结构</a></li>
	    <li class="danger label" ><a href="/tag/xing-wei-xing.html">行为型</a></li>
	    <li class="danger label" ><a href="/tag/yuan-ma.html">源码</a></li>
	    <li class="danger label" ><a href="/tag/jie-gou-xing.html">结构型</a></li>
	    <li class="danger label" ><a href="/tag/ji-chu.html">基础</a></li>
	    <li class="danger label" ><a href="/tag/mysqlsi-wei-dao-tu.html">mysql思维导图</a></li>
	    <li class="danger label" ><a href="/tag/suo-you-hua.html">锁优化</a></li>
</ul>



<!---->
<!--<nav class="widget">-->
  <!--<h4>Social</h4>-->
  <!--<ul class="blank">-->
  <!---->
    <!--<li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>-->
  <!---->
    <!--<li><a href="http://www.spring4all.com/">Spring中文社区</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/alibaba">alibaba开源项目</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/google">google开源项目</a></li>-->
  <!---->
  <!--</ul>-->
<!--</nav>-->
<!---->


</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">



                   <address id="about" class="vcard body">
                       <br>
                       <nav class="widget">
                           <h4>推荐博客</h4>
                           <ul class="blank">
                               <li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>
                               <li><a href="http://www.spring4all.com/">Spring中文社区</a></li>
                               <li><a href="https://github.com/alibaba">alibaba开源项目</a></li>
                               <li><a href="https://github.com/google">google开源项目</a></li>
                           </ul>
                       </nav>
                       <br/>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-119892182-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'nicky-chen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="/theme/js/libs/gumby.min.js"></script>
  <script src="/theme/js/plugins.js"></script>
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</body>
</html>