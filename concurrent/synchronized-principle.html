<!DOCTYPE html>
<html lang="zh">
<head>

        <title>synchronized实现原理及锁优化</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 RSS Feed" />
        <link href="/feeds/concurrent.rss.xml" type="application/rss+xml" rel="alternate" title="南乡清水 Categories RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/pygment.css" />
        <link rel="shortcut icon" href="/theme/images/favicon.ico">

        <script src="/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">

    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="/">南乡清水 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

                <ul class="columns">
                    <li><a href="/">首页</a></li>

                    <li
><a href="/yue-du-shu-dan.html">阅读书单</a></li>
                    <li
><a href="/zai-xian-gong-ju.html">在线工具</a></li>
                    <li
><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>
                    <li
><a href="/guan-yu-wo.html">关于我</a></li>
                     <li><a href="/archives.html"><i class="active"></i>归档日志</a></li>
                    <form class="navbar-search pull-right" action="/search.html">
                        <input type="text" class="search-query" placeholder="站内搜" name="q" id="s">
                    </form>
                </ul>
            </div>


<section id="content" class="body">

   <div class="row">

<div id="toc" class="threes columns" style="font-size: 65%">
    <br>
    <h4 style="font-size: 1rem">文章目录</h4>
</div>        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="/concurrent/synchronized-principle.html" rel="bookmark"
                   title="Permalink to synchronized实现原理及锁优化">synchronized实现原理及锁优化</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2018-05-14T19:16:00+08:00">
                周一 14 五月 2018
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="/author/nicky_chin.html"> nicky_chin</a>
              </address>
            </footer><!-- /.post-info -->
            <div id="contents" class="entry-content">
              <h1>1.引言</h1>
<p>并发编程中synchronized是重量级锁，但随着JVM1.6对synchronized进行优化后，有些情况下它并不那么重，本文介绍了Java SE1.6中为了减少获得锁和释放锁带来的性能消耗而引入的偏向锁和轻量级锁，以及锁的存储结构和升级过程。</p>
<h1>2.术语定义</h1>
<p><strong>CAS(Compare and Swap):</strong>  比较并交换。用于在硬件层面上提供原子性操作。在 Intel 处理器中，比较并交换通过指令cmpxchg实现。比较是否和给定的数值一致，如果一致则修改，不一致则不修改。</p>
<h1>3.同步的基础</h1>
<p>Java中的每一个对象都可以作为锁。
对于同步方法，锁是当前实例对象。
对于静态同步方法，锁是当前对象的Class对象。
对于同步方法块，锁是synchonized括号里配置的对象。</p>
<p>我们通过java代码和字节码分析下
java代码如下：</p>
<div class="highlight"><pre><span></span>public class SyncTest {

    private static double a = 1;

    public synchronized void plusNumber() {
        a++;
    }

    public void minusNumber() {
        System.out.println(a);
        synchronized (this) {
            a--;
        }
    }

    public synchronized static void divide() {

        a = a / 0.1;
    }

}
</pre></div>


<p>解析成字节码指令:</p>
<div class="highlight"><pre><span></span><span class="o">//</span><span class="err">同步方法</span>
<span class="nt">public</span> <span class="nt">synchronized</span> <span class="nt">void</span> <span class="nt">plusNumber</span><span class="o">();</span>                                                                       
  <span class="nt">descriptor</span><span class="o">:</span> <span class="o">()</span><span class="nt">V</span>                                                                                            
  <span class="nt">flags</span><span class="o">:</span> <span class="nt">ACC_PUBLIC</span><span class="o">,</span> <span class="nt">ACC_SYNCHRONIZED</span>                                                                        
  <span class="nt">Code</span><span class="o">:</span>                                                                                                      
    <span class="nt">stack</span><span class="o">=</span><span class="nt">4</span><span class="o">,</span> <span class="nt">locals</span><span class="o">=</span><span class="nt">1</span><span class="o">,</span> <span class="nt">args_size</span><span class="o">=</span><span class="nt">1</span>                                                                           
       <span class="nt">0</span><span class="o">:</span> <span class="nt">getstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
       <span class="nt">3</span><span class="o">:</span> <span class="nt">dconst_1</span>                                                                                           
       <span class="nt">4</span><span class="o">:</span> <span class="nt">dadd</span>                                                                                               
       <span class="nt">5</span><span class="o">:</span> <span class="nt">putstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
       <span class="nt">8</span><span class="o">:</span> <span class="nt">return</span>                                                                                             
    <span class="nt">LineNumberTable</span><span class="o">:</span>                                                                                         
      <span class="nt">line</span> <span class="nt">12</span><span class="o">:</span> <span class="nt">0</span>                                                                                             
      <span class="nt">line</span> <span class="nt">13</span><span class="o">:</span> <span class="nt">8</span>                                                                                             

<span class="o">//</span><span class="err">同步块</span>                                                                                                             
<span class="nt">public</span> <span class="nt">void</span> <span class="nt">minusNumber</span><span class="o">();</span>                                                                                   
  <span class="nt">descriptor</span><span class="o">:</span> <span class="o">()</span><span class="nt">V</span>                                                                                            
  <span class="nt">flags</span><span class="o">:</span> <span class="nt">ACC_PUBLIC</span>                                                                                          
  <span class="nt">Code</span><span class="o">:</span>                                                                                                      
    <span class="nt">stack</span><span class="o">=</span><span class="nt">4</span><span class="o">,</span> <span class="nt">locals</span><span class="o">=</span><span class="nt">3</span><span class="o">,</span> <span class="nt">args_size</span><span class="o">=</span><span class="nt">1</span>                                                                           
       <span class="nt">0</span><span class="o">:</span> <span class="nt">getstatic</span>     <span class="p">#</span><span class="nn">3</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">java</span><span class="o">/</span><span class="nt">lang</span><span class="o">/</span><span class="nt">System</span><span class="p">.</span><span class="nc">out</span><span class="p">:</span><span class="nd">Ljava</span><span class="o">/</span><span class="nt">io</span><span class="o">/</span><span class="nt">PrintStream</span><span class="o">;</span>              
       <span class="nt">3</span><span class="o">:</span> <span class="nt">getstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
       <span class="nt">6</span><span class="o">:</span> <span class="nt">invokevirtual</span> <span class="p">#</span><span class="nn">4</span>                  <span class="o">//</span> <span class="nt">Method</span> <span class="nt">java</span><span class="o">/</span><span class="nt">io</span><span class="o">/</span><span class="nt">PrintStream</span><span class="p">.</span><span class="nc">println</span><span class="o">:(</span><span class="nt">D</span><span class="o">)</span><span class="nt">V</span>                       
       <span class="nt">9</span><span class="o">:</span> <span class="nt">aload_0</span>                                                                                            
      <span class="nt">10</span><span class="o">:</span> <span class="nt">dup</span>                                                                                                
      <span class="nt">11</span><span class="o">:</span> <span class="nt">astore_1</span>                                                                                           
      <span class="nt">12</span><span class="o">:</span> <span class="nt">monitorenter</span>                                                                                       
      <span class="nt">13</span><span class="o">:</span> <span class="nt">getstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
      <span class="nt">16</span><span class="o">:</span> <span class="nt">dconst_1</span>                                                                                           
      <span class="nt">17</span><span class="o">:</span> <span class="nt">dsub</span>                                                                                               
      <span class="nt">18</span><span class="o">:</span> <span class="nt">putstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
      <span class="nt">21</span><span class="o">:</span> <span class="nt">aload_1</span>                                                                                            
      <span class="nt">22</span><span class="o">:</span> <span class="nt">monitorexit</span>                                                                                        
      <span class="nt">23</span><span class="o">:</span> <span class="nt">goto</span>          <span class="nt">31</span>                                                                                   
      <span class="nt">26</span><span class="o">:</span> <span class="nt">astore_2</span>                                                                                           
      <span class="nt">27</span><span class="o">:</span> <span class="nt">aload_1</span>                                                                                            
      <span class="nt">28</span><span class="o">:</span> <span class="nt">monitorexit</span>                                                                                        
      <span class="nt">29</span><span class="o">:</span> <span class="nt">aload_2</span>                                                                                            
      <span class="nt">30</span><span class="o">:</span> <span class="nt">athrow</span>                                                                                             
      <span class="nt">31</span><span class="o">:</span> <span class="nt">return</span>                                                                                             
    <span class="nt">Exception</span> <span class="nt">table</span><span class="o">:</span>                                                                                         
       <span class="nt">from</span>    <span class="nt">to</span>  <span class="nt">target</span> <span class="nt">type</span>                                                                               
          <span class="nt">13</span>    <span class="nt">23</span>    <span class="nt">26</span>   <span class="nt">any</span>                                                                               
          <span class="nt">26</span>    <span class="nt">29</span>    <span class="nt">26</span>   <span class="nt">any</span>                                                                               

<span class="o">//</span><span class="err">静态同步方法</span>                                                                                                             
<span class="nt">public</span> <span class="nt">static</span> <span class="nt">synchronized</span> <span class="nt">void</span> <span class="nt">divide</span><span class="o">();</span>                                                                    
  <span class="nt">descriptor</span><span class="o">:</span> <span class="o">()</span><span class="nt">V</span>                                                                                            
  <span class="nt">flags</span><span class="o">:</span> <span class="nt">ACC_PUBLIC</span><span class="o">,</span> <span class="nt">ACC_STATIC</span><span class="o">,</span> <span class="nt">ACC_SYNCHRONIZED</span>                                                            
  <span class="nt">Code</span><span class="o">:</span>                                                                                                      
    <span class="nt">stack</span><span class="o">=</span><span class="nt">4</span><span class="o">,</span> <span class="nt">locals</span><span class="o">=</span><span class="nt">0</span><span class="o">,</span> <span class="nt">args_size</span><span class="o">=</span><span class="nt">0</span>                                                                           
       <span class="nt">0</span><span class="o">:</span> <span class="nt">getstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
       <span class="nt">3</span><span class="o">:</span> <span class="nt">ldc2_w</span>        <span class="p">#</span><span class="nn">5</span>                  <span class="o">//</span> <span class="nt">double</span> <span class="nt">0</span><span class="p">.</span><span class="nc">1d</span>                                                   
       <span class="nt">6</span><span class="o">:</span> <span class="nt">ddiv</span>                                                                                               
       <span class="nt">7</span><span class="o">:</span> <span class="nt">putstatic</span>     <span class="p">#</span><span class="nn">2</span>                  <span class="o">//</span> <span class="nt">Field</span> <span class="nt">a</span><span class="p">:</span><span class="nd">D</span>                                                     
      <span class="nt">10</span><span class="o">:</span> <span class="nt">return</span>                                                                                             
    <span class="nt">LineNumberTable</span><span class="o">:</span>                                                                                         
      <span class="nt">line</span> <span class="nt">24</span><span class="o">:</span> <span class="nt">0</span>                                                                                             
      <span class="nt">line</span> <span class="nt">26</span><span class="o">:</span> <span class="nt">10</span>                                                                                            
</pre></div>


<p>从上述指令我们可以得出以下结论：</p>
<blockquote>
<ol>
<li>同步代码块是使用monitorenter和monitorexit指令实现的，会在同步块的区域通过监听器对象去获取锁和释放锁，从而在字节码层面来控制同步scope.</li>
<li>同步方法和静态同步方法依靠的是方法修饰符上的ACC_SYNCHRONIZED实现。JVM根据该修饰符来实现方法的同步。当方法调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先获取monitor，获取成功之后才能执行方法体，方法执行完后再释放monitor。在方法执行期间，其他任何线程都无法再获得同一个monitor对象</li>
</ol>
</blockquote>
<p>当一个线程访问同步代码块时，根据happens-before原则，它必须获取锁才能进入代码块，退出或抛出异常时必须释放锁。那么锁存在哪里？锁里面会存储什么信息？</p>
<h1>4. 同步的原理</h1>
<p><strong>4.1 Java对象头</strong>
HotSpot虚拟机中，对象在内存中存储分为三块区域：对象头、实例数据和对齐填充 
HotSpot虚拟机的对象头(Object Header)包括两部分信息:
第一部分<strong>"Mark Word":</strong> 用于存储对象自身的运行时数据， 如哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等等.</p>
<p>第二部分<strong>"Klass Pointer":</strong> 对象指向它的类的元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。(数组，对象头中还须有一块用于记录数组长度的数据，因为虚拟机可以通过普通Java对象的元数据信息确定Java对象的大小，但是从数组的元数据中无法确定数组的大小。 ) </p>
<p>对象头默认存储结构</p>
<p><img alt="默认存储结构" src="https://upload-images.jianshu.io/upload_images/10175660-8e2e456b957e939c.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>在运行期间，Mark Word里存储的数据会随着锁标志位的变化而变化。Mark Word可能变化为存储以下4种数据（32位系统）</p>
<p><img alt="运行时存储结构变化" src="https://upload-images.jianshu.io/upload_images/10175660-90c674b807003850.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>对象头的数据结构C++源码可以查看 <a href="https://bitbucket.org/luchsh/openjdk8-hotspot/src/ed621d125d02f61e1f08c86aa43c2e85a79eadea/src/share/vm/oops/markOop.hpp?at=default&amp;fileviewer=file-view-default">openjdk\hotspot\src\share\vm\oops.markOop.hpp</a></p>
<div class="highlight"><pre><span></span>// 32 bits:
//  --------
//     hash:25 ------------&gt;| age:4    biased_lock:1 lock:2 (normal object)
//     JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)
//     size:32 ------------------------------------------&gt;| (CMS free block)
//     PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)
//
hash： 保存对象的哈希码
age： 保存对象的分代年龄
biased_lock： 偏向锁标识位
lock： 锁状态标识位
JavaThread*： 保存持有偏向锁的线程ID
epoch： 保存偏向时间戳
</pre></div>


<p><strong>4.2 Monitor Record</strong></p>
<p>监听器的实现依赖于objectMonitor对象源码如下：
<a href="https://bitbucket.org/luchsh/openjdk8-hotspot/src/ed621d125d02f61e1f08c86aa43c2e85a79eadea/src/share/vm/runtime/objectMonitor.hpp?at=default&amp;fileviewer=file-view-default">openjdk\hotspot\src\share\vm\runtime\objectMonitor.hpp</a></p>
<p>监听器具体存储的数据结构</p>
<div class="highlight"><pre><span></span>ObjectMonitor() {
    _header       = NULL;//markOop对象头
    _count        = 0;
    _waiters      = 0,//等待线程数
    _recursions   = 0;//重入次数
    _object       = NULL;//监视器锁寄生的对象。锁不是平白出现的，而是寄托存储于对象中。
    _owner        = NULL;//初始时为NULL表示当前没有任何线程拥有该monitor record，当线程成功拥有该锁后保存线程唯一标识，当锁被释放时又设置为NULL
    _WaitSet      = NULL;//处于wait状态的线程，会被加入到wait set；
    _WaitSetLock  = 0 ;
    _Responsible  = NULL ;
    _succ         = NULL ;
    _cxq          = NULL ;
    FreeNext      = NULL ;
    _EntryList    = NULL ;//处于等待锁block状态的线程，会被加入到entry set；
    _SpinFreq     = 0 ;
    _SpinClock    = 0 ;
    OwnerIsThread = 0 ;// _owner is (Thread *) vs SP/BasicLock
  }
</pre></div>


<p>每个线程都有两个ObjectMonitor对象列表，分别为free和used列表，如果当前free列表为空，线程将向全局global list请求分配ObjectMonitor。
ObjectMonitor对象中有两个队列：_WaitSet 和 _EntryList，用来保存ObjectWaiter对象列表；
<img alt="monitor" src="https://upload-images.jianshu.io/upload_images/10175660-d31da0ecab6cd54c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1>5. JVM中锁的优化</h1>
<p><strong>5.1 锁机制升级流程</strong>
偏向锁--》轻量级锁--》重量级锁</p>
<p>synchronized在JVM被编译为monitorenter、monitorexit指令来获取和释放互斥锁.。
解释器执行monitorenter时会进入到<a href="https://bitbucket.org/luchsh/openjdk8-hotspot/src/ed621d125d02f61e1f08c86aa43c2e85a79eadea/src/share/vm/interpreter/interpreterRuntime.cpp?at=default&amp;fileviewer=file-view-default">openjdk\hotspot\src\share\vm\interpreter\InterpreterRuntime.cpp</a>的InterpreterRuntime::monitorenter函数，
具体实现如下：</p>
<div class="highlight"><pre><span></span><span class="c1">//%note monitor_1</span>
<span class="n">IRT_ENTRY_NO_ASYNC</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">InterpreterRuntime</span><span class="o">::</span><span class="n">monitorenter</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">BasicObjectLock</span><span class="o">*</span> <span class="n">elem</span><span class="p">))</span>
<span class="cp">#ifdef ASSERT</span>
  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PrintBiasedLockingStatistics</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Atomic</span><span class="o">::</span><span class="n">inc</span><span class="p">(</span><span class="n">BiasedLocking</span><span class="o">::</span><span class="n">slow_path_entry_count_addr</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">Handle</span> <span class="n">h_obj</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">());</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">heap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_in_reserved_or_null</span><span class="p">(</span><span class="n">h_obj</span><span class="p">()),</span>
         <span class="s">&quot;must be NULL or an object&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UseBiasedLocking</span><span class="p">)</span> <span class="p">{</span><span class="c1">//标识虚拟机是否开启偏向锁功能,默认开启</span>
    <span class="c1">//偏向锁逻辑</span>
    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//轻量级锁逻辑</span>
    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">slow_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="n">CHECK</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">heap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_in_reserved_or_null</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">()),</span>
         <span class="s">&quot;must be NULL or an object&quot;</span><span class="p">);</span>
<span class="cp">#ifdef ASSERT</span>
  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">IRT_END</span>
</pre></div>


<p><strong>5.2 偏向锁</strong>
大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低而引入了偏向锁。当一个线程访问同步块并获取锁时，会在对象头和栈帧中的锁记录里存储锁偏向的线程ID，以后该线程在进入和退出同步块时不需要进行CAS操作来加锁和解锁，只需简单地测试一下对象头的Mark Word里是否存储着指向当前线程的偏向锁。如果测试成功，表示线程已经获得了锁。如果测试失败，则需要再测试一下Mark Word中偏向锁的标识是否设置成1（表示当前是偏向锁）：如果没有设置，则使用CAS竞争锁；如果设置了，则尝试使用CAS将对象头的偏向锁指向当前线程。
<strong><em>注意：当锁有竞争关系的时候，需要解除偏向锁，进入轻量级锁。</em></strong>
偏向锁执行流程，线程1演示了偏向锁初始化的流程，线程2演示了偏向锁撤销的流程</p>
<p><img alt="偏向锁" src="https://upload-images.jianshu.io/upload_images/10175660-2b9a1f8e0028dd6e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>偏向锁在Java 6和Java 7里是默认启用的，但是它在应用程序启动几秒钟之后才激活，如有必要可以使用JVM参数来关闭延迟：<strong>XX:BiasedLockingStartupDelay=0</strong>。如果确定应用的锁通常情况下处于竞争状态，可以通过JVM参数关闭偏向锁：<strong>-XX:-UseBiasedLocking=false</strong>，那么程序默认会进入轻量级锁状态。</p>
<p>偏向锁获取的具体逻辑在<a href="https://bitbucket.org/luchsh/openjdk8-hotspot/src/ed621d125d02f61e1f08c86aa43c2e85a79eadea/src/share/vm/runtime/synchronizer.cpp?at=default&amp;fileviewer=file-view-default">openjdk\hotspot\src\share\vm\runtime\synchronizer.cpp</a>的ObjectSynchronizer::fast_enter函数下，具体代码如下：</p>
<div class="highlight"><pre><span></span><span class="nt">void</span> <span class="nt">ObjectSynchronizer</span><span class="p">::</span><span class="nd">fast_enter</span><span class="o">(</span><span class="nt">Handle</span> <span class="nt">obj</span><span class="o">,</span> <span class="nt">BasicLock</span><span class="o">*</span> <span class="nt">lock</span><span class="o">,</span> <span class="nt">bool</span> <span class="nt">attempt_rebias</span><span class="o">,</span> <span class="nt">TRAPS</span><span class="o">)</span> <span class="p">{</span>
 <span class="err">if</span> <span class="err">(UseBiasedLocking)</span> <span class="err">{//jvm是否开启了偏向锁</span>
    <span class="err">//是否在全局安全点，如达到安全点撤销偏向锁，同时升级为轻量级锁</span>
    <span class="err">if</span> <span class="err">(!</span><span class="n">SafepointSynchronize</span><span class="p">:</span><span class="o">:</span><span class="nf">is_at_safepoint</span><span class="p">())</span> <span class="err">{</span>
      <span class="o">//</span><span class="err">偏向锁的获取</span>
      <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">Condition</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="nf">revoke_and_rebias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attempt_rebias</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
      <span class="err">if</span> <span class="err">(cond</span> <span class="err">==</span> <span class="n">BiasedLocking</span><span class="p">:</span><span class="o">:</span><span class="n">BIAS_REVOKED_AND_REBIASED</span><span class="p">)</span> <span class="err">{</span>
        <span class="n">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="err">}</span> <span class="nt">else</span> <span class="p">{</span>
      <span class="err">assert(!attempt_rebias,</span> <span class="err">&quot;can</span> <span class="err">not</span> <span class="err">rebias</span> <span class="err">toward</span> <span class="err">VM</span> <span class="err">thread&quot;)</span><span class="p">;</span>
     <span class="err">//偏向锁的撤销</span>
      <span class="n">BiasedLocking</span><span class="p">:</span><span class="o">:</span><span class="nf">revoke_at_safepoint</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nt">assert</span><span class="o">(!</span><span class="nt">obj-</span><span class="o">&gt;</span><span class="nt">mark</span><span class="o">()</span><span class="nt">-</span><span class="o">&gt;</span><span class="nt">has_bias_pattern</span><span class="o">(),</span> <span class="s2">&quot;biases should be revoked by now&quot;</span><span class="o">);</span>
 <span class="err">}</span>
 <span class="o">//</span><span class="err">获取轻量级锁</span>
 <span class="nt">slow_enter</span> <span class="o">(</span><span class="nt">obj</span><span class="o">,</span> <span class="nt">lock</span><span class="o">,</span> <span class="nt">THREAD</span><span class="o">)</span> <span class="o">;</span>
<span class="err">}</span>
</pre></div>


<p><strong>5.3 轻量级锁</strong>
1&gt;加锁
线程在执行同步块之前，JVM会先在当前线程的栈桢中创建用于存储锁记录的空间，并将对象头中的Mark Word复制到锁记录中，官方称为Displaced Mark Word。然后线程尝试使用CAS将对象头中的Mark Word替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁。
2&gt;解锁
轻量级解锁时，会使用原子的CAS操作将Displaced Mark Word替换回到对象头，如果成功，则表示没有竞争发生。如果失败，表示当前锁存在竞争，锁就会膨胀成重量级锁。
下图展示两个线程同时争夺锁，导致锁膨胀的流程图:</p>
<p><img alt="轻量级锁" src="https://upload-images.jianshu.io/upload_images/10175660-94e49823fb3588d7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>自旋的线程在自旋过程中，成功获得资源(即之前获的资源的线程执行完成并释放了共享资源)，则整个状态依然处于轻量级锁的状态，如果自旋失败进入重量级锁的状态，这个时候，自旋的线程进行阻塞，等待之前线程执行完成并唤醒自己。因为自旋会消耗CPU，为了避免无用的自旋（比如获得锁的线程被阻塞住了），一旦锁升级成重量级锁，就不会再恢复到轻量级锁状态。当锁处于这个状态下，其他线程试图获取锁时，都会被阻塞住，当持有锁的线程释放锁之后会唤醒这些线程，被唤醒的线程就会进行新一轮的夺锁之争。</p>
<p>多个线程竞争偏向锁升级为轻量级锁，会尝试获取轻量级锁，其入口位于<a href="https://bitbucket.org/luchsh/openjdk8-hotspot/src/ed621d125d02f61e1f08c86aa43c2e85a79eadea/src/share/vm/runtime/synchronizer.cpp?at=default&amp;fileviewer=file-view-default">ObjectSynchronizer::slow_enter</a>函数，具体代码如下：</p>
<div class="highlight"><pre><span></span><span class="nt">void</span> <span class="nt">ObjectSynchronizer</span><span class="p">::</span><span class="nd">slow_enter</span><span class="o">(</span><span class="nt">Handle</span> <span class="nt">obj</span><span class="o">,</span> <span class="nt">BasicLock</span><span class="o">*</span> <span class="nt">lock</span><span class="o">,</span> <span class="nt">TRAPS</span><span class="o">)</span> <span class="p">{</span>
  <span class="err">markOop</span> <span class="err">mark</span> <span class="err">=</span> <span class="err">obj-&gt;mark()</span><span class="p">;</span><span class="err">//获取对象头的Mark</span> <span class="err">Word</span>
  <span class="err">assert(!mark-&gt;has_bias_pattern(),</span> <span class="err">&quot;should</span> <span class="err">not</span> <span class="err">see</span> <span class="err">bias</span> <span class="err">pattern</span> <span class="err">here&quot;)</span><span class="p">;</span>

  <span class="err">if</span> <span class="err">(mark-&gt;is_neutral())</span> <span class="err">{//是否为无锁状态001</span>
    <span class="err">//</span> <span class="err">Anticipate</span> <span class="err">successful</span> <span class="err">CAS</span> <span class="err">--</span> <span class="err">the</span> <span class="err">ST</span> <span class="err">of</span> <span class="err">the</span> <span class="err">displaced</span> <span class="err">mark</span> <span class="err">must</span>
    <span class="err">//</span> <span class="err">be</span> <span class="err">visible</span> <span class="err">&lt;=</span> <span class="err">the</span> <span class="err">ST</span> <span class="err">performed</span> <span class="err">by</span> <span class="err">the</span> <span class="err">CAS.</span>
    <span class="err">lock-&gt;set_displaced_header(mark)</span><span class="p">;</span><span class="err">//把mark保存到BasicLock对象的_displaced_header字段</span>
    <span class="err">//原子操作保证只有一个线程可以把指向栈帧的指针复制到Mark</span> <span class="err">Word</span>
    <span class="err">if</span> <span class="err">(mark</span> <span class="err">==</span> <span class="err">(markOop)</span> <span class="n">Atomic</span><span class="p">:</span><span class="o">:</span><span class="nf">cmpxchg_ptr</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="nf">obj</span><span class="p">()</span><span class="o">-</span><span class="err">&gt;</span><span class="nf">mark_addr</span><span class="p">(),</span> <span class="n">mark</span><span class="p">))</span> <span class="err">{</span><span class="o">//</span><span class="n">CAS</span><span class="err">成功，释放栈锁</span>
      <span class="n">TEVENT</span> <span class="p">(</span><span class="n">slow_enter</span><span class="o">:</span> <span class="n">release</span> <span class="n">stacklock</span><span class="p">)</span> <span class="p">;</span>
      <span class="err">return</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="o">//</span> <span class="nt">Fall</span> <span class="nt">through</span> <span class="nt">to</span> <span class="nt">inflate</span><span class="o">()</span> <span class="o">...</span>
  <span class="err">}</span> <span class="nt">else</span>
  <span class="nt">if</span> <span class="o">(</span><span class="nt">mark-</span><span class="o">&gt;</span><span class="nt">has_locker</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="nt">THREAD-</span><span class="o">&gt;</span><span class="nt">is_lock_owned</span><span class="o">((</span><span class="nt">address</span><span class="o">)</span><span class="nt">mark-</span><span class="o">&gt;</span><span class="nt">locker</span><span class="o">()))</span> <span class="p">{</span>
    <span class="err">assert(lock</span> <span class="err">!=</span> <span class="err">mark-&gt;locker(),</span> <span class="err">&quot;must</span> <span class="err">not</span> <span class="err">re-lock</span> <span class="err">the</span> <span class="err">same</span> <span class="err">lock&quot;)</span><span class="p">;</span>
    <span class="err">assert(lock</span> <span class="err">!=</span> <span class="err">(BasicLock*)obj-&gt;mark(),</span> <span class="err">&quot;don&#39;t</span> <span class="err">relock</span> <span class="err">with</span> <span class="err">same</span> <span class="err">BasicLock&quot;)</span><span class="p">;</span>
    <span class="err">lock-&gt;set_displaced_header(NULL)</span><span class="p">;</span>
    <span class="err">return</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">#</span><span class="nn">if</span> <span class="nt">0</span>
  <span class="o">//</span> <span class="nt">The</span> <span class="nt">following</span> <span class="nt">optimization</span> <span class="nt">isn</span><span class="err">&#39;</span><span class="nt">t</span> <span class="nt">particularly</span> <span class="nt">useful</span><span class="o">.</span>
  <span class="nt">if</span> <span class="o">(</span><span class="nt">mark-</span><span class="o">&gt;</span><span class="nt">has_monitor</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="nt">mark-</span><span class="o">&gt;</span><span class="nt">monitor</span><span class="o">()</span><span class="nt">-</span><span class="o">&gt;</span><span class="nt">is_entered</span><span class="o">(</span><span class="nt">THREAD</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">lock-&gt;set_displaced_header</span> <span class="err">(NULL)</span> <span class="p">;</span>
    <span class="err">return</span> <span class="p">;</span>
  <span class="p">}</span>
<span class="p">#</span><span class="nn">endif</span>

  <span class="o">//</span> <span class="nt">The</span> <span class="nt">object</span> <span class="nt">header</span> <span class="nt">will</span> <span class="nt">never</span> <span class="nt">be</span> <span class="nt">displaced</span> <span class="nt">to</span> <span class="nt">this</span> <span class="nt">lock</span><span class="o">,</span>
  <span class="o">//</span> <span class="nt">so</span> <span class="nt">it</span> <span class="nt">does</span> <span class="nt">not</span> <span class="nt">matter</span> <span class="nt">what</span> <span class="nt">the</span> <span class="nt">value</span> <span class="nt">is</span><span class="o">,</span> <span class="nt">except</span> <span class="nt">that</span> <span class="nt">it</span>
  <span class="o">//</span> <span class="nt">must</span> <span class="nt">be</span> <span class="nt">non-zero</span> <span class="nt">to</span> <span class="nt">avoid</span> <span class="nt">looking</span> <span class="nt">like</span> <span class="nt">a</span> <span class="nt">re-entrant</span> <span class="nt">lock</span><span class="o">,</span>
  <span class="o">//</span> <span class="nt">and</span> <span class="nt">must</span> <span class="nt">not</span> <span class="nt">look</span> <span class="nt">locked</span> <span class="nt">either</span><span class="o">.</span>
  <span class="nt">lock-</span><span class="o">&gt;</span><span class="nt">set_displaced_header</span><span class="o">(</span><span class="nt">markOopDesc</span><span class="p">::</span><span class="nd">unused_mark</span><span class="o">());</span>
 <span class="o">//</span><span class="err">锁膨胀升级为重量级锁逻辑</span>
  <span class="nt">ObjectSynchronizer</span><span class="p">::</span><span class="nd">inflate</span><span class="o">(</span><span class="nt">THREAD</span><span class="o">,</span> <span class="nt">obj</span><span class="o">())</span><span class="nt">-</span><span class="o">&gt;</span><span class="nt">enter</span><span class="o">(</span><span class="nt">THREAD</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>


<p><strong>5.4 锁的优缺点对比</strong>
<img alt="锁对比" src="https://upload-images.jianshu.io/upload_images/10175660-0c7782fa4c2024c3.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p><strong>5.5 锁粗化:</strong>就是将多次连接在一起的加锁、解锁操作合并为一次，将多个连续的锁扩展成一个范围更大的锁。举个例子:</p>
<div class="highlight"><pre><span></span>public class LockCoarsening {

    private StringBuffer stringBuffer = new StringBuffer(20);

    public void append(){
        stringBuffer.append(&quot;w&quot;);
        stringBuffer.append(&quot;h&quot;);
        stringBuffer.append(&quot;y&quot;);
    }

}
</pre></div>


<p>这里每次调用stringBuffer.append方法都需要加锁和解锁，如果虚拟机检测到有一系列连串的对同一个对象加锁和解锁操作，就会将其合并成一次范围更大的加锁和解锁操作，即在第一次append方法时进行加锁，最后一次append方法结束后进行解锁。</p>
<p><strong>5.6 锁消除</strong> 
锁消除即删除不必要的加锁操作。根据代码逃逸技术，如果判断到一段代码中，堆上的数据不会逃逸出当前线程，那么可以认为这段代码是线程安全的，不必要加锁。逃逸分析和锁消除分别可以使用参数<strong><em>-XX:+DoEscapeAnalysis和-XX:+EliminateLocks(锁消除必须在-server模式下)开启</em></strong></p>
<p><strong>5.7 适应性自旋</strong>
当前锁处于膨胀，会进行自旋。自旋是需要消耗CPU的，如果一直获取不到锁的话，那线程一直处在自旋状态，消耗CPU资源。为了解决这个问题JDK采用—<strong>适应性自旋</strong>，线程如果自旋成功了，则下次自旋的次数会更多，如果自旋失败了，则自旋的次数就会减少。另外自旋虽然会占用CPU资源，但不会一直占用CPU资源，每隔一段时间会通过<strong>os::NakedYield方法</strong>放弃CPU资源，或通过<strong>park方法</strong>挂起；如果其他线程完成锁的膨胀操作，则退出自旋并返回</p>
<h1>Reference</h1>
<p><a href="http://ifeve.com/java-synchronized/">并发编程网-Java SE1.6中的synchronized</a>
<a href="http://www.jianshu.com/p/c5058b6fe8e5">JVM源码分析之synchronized实现</a>
<a href="https://www.usenix.org/legacy/event/jvm01/full_papers/dice/dice.pdf">Implementing Fast Java Monitors with Relaxed-Locks</a></p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "concurrent/synchronized-principle.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://nicky-chen.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns" style="font-size: 80%">


    <nav class="widget">
        <h4>个人链接</h4>
        <ul class="blank">
            <li><a href="https://stackoverflow.com/users/7444060/nicky-chen">StackOverFlow</a></li>
            <li><a href="https://github.com/nicky-chen">个人GitHub</a></li>
            <li><a href="https://www.jianshu.com/u/c44ed4847c3d">简书博客</a></li>
        </ul>
    </nav>

<h4>专题分类</h4>

 <ul>
     <!---->
     <!---->
     <!---->
     <!--<li><a href="/yue-du-shu-dan.html">阅读书单</a></li>-->
     <!---->
     <!--<li><a href="/zai-xian-gong-ju.html">在线工具</a></li>-->
     <!---->
     <!--<li><a href="/kai-yuan-xiang-mu.html">开源项目</a></li>-->
     <!---->
     <!--<li><a href="/guan-yu-wo.html">关于我</a></li>-->
     <!---->
     <!--<li class="divider-vertical"></li>-->
     <!---->

     <li >
         <a href="/algorithm/index.html">
             Algorithm
         </a>
     </li>
     <li >
         <a href="/classloader/index.html">
             classloader
         </a>
     </li>
     <li class="active" >
         <a href="/concurrent/index.html">
             concurrent
         </a>
     </li>
     <li >
         <a href="/design-pattern/index.html">
             design-pattern
         </a>
     </li>
     <li >
         <a href="/distrubuted/index.html">
             distrubuted
         </a>
     </li>
     <li >
         <a href="/java-base/index.html">
             java-base
         </a>
     </li>
     <li >
         <a href="/mysql/index.html">
             MySql
         </a>
     </li>
  </ul>

<!---->
<!--<h4>Categories</h4>-->
<!--<ul class="blank">-->
	<!---->
		<!--<li><a href="/algorithm/index.html">Algorithm</a></li>-->
	<!---->
		<!--<li><a href="/classloader/index.html">classloader</a></li>-->
	<!---->
		<!--<li><a href="/concurrent/index.html">concurrent</a></li>-->
	<!---->
		<!--<li><a href="/design-pattern/index.html">design-pattern</a></li>-->
	<!---->
		<!--<li><a href="/distrubuted/index.html">distrubuted</a></li>-->
	<!---->
		<!--<li><a href="/java-base/index.html">java-base</a></li>-->
	<!---->
		<!--<li><a href="/mysql/index.html">MySql</a></li>-->
	<!---->
<!--</ul>-->
<!---->


<h4>标签</h4>
	<ul class="blank">
	    <li class="danger label" ><a href="/tag/li-lun.html">理论</a></li>
	    <li class="danger label" ><a href="/tag/chuang-jian-xing.html">创建型</a></li>
	    <li class="danger label" ><a href="/tag/ku-ji-you-hua.html">库级优化</a></li>
	    <li class="danger label" ><a href="/tag/kuang-jia-ji-chu.html">框架基础</a></li>
	    <li class="danger label" ><a href="/tag/fen-bu-shi-idfang-an.html">分布式ID方案</a></li>
	    <li class="danger label" ><a href="/tag/yuan-ma.html">源码</a></li>
	    <li class="danger label" ><a href="/tag/si-wei-dao-tu.html">思维导图</a></li>
	    <li class="danger label" ><a href="/tag/xing-wei-xing.html">行为型</a></li>
	    <li class="danger label" ><a href="/tag/shu-ju-jie-gou.html">数据结构</a></li>
	    <li class="danger label" ><a href="/tag/ji-chu.html">基础</a></li>
	    <li class="danger label" ><a href="/tag/suo-you-hua.html">锁优化</a></li>
	    <li class="danger label" ><a href="/tag/jie-gou-xing.html">结构型</a></li>
</ul>



<!---->
<!--<nav class="widget">-->
  <!--<h4>Social</h4>-->
  <!--<ul class="blank">-->
  <!---->
    <!--<li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>-->
  <!---->
    <!--<li><a href="http://www.spring4all.com/">Spring中文社区</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/alibaba">alibaba开源项目</a></li>-->
  <!---->
    <!--<li><a href="https://github.com/google">google开源项目</a></li>-->
  <!---->
  <!--</ul>-->
<!--</nav>-->
<!---->


</div> </div><!-- /.row -->
  <div class="pagination">★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆★✪☆
      <ul>
        <li class="prev"><a href="/concurrent/juc-tree-info.html">Next →</a></li>
        <li><a href="/archives.html">博客导航</a></li>
        <li class="next"><a href="/algorithm/btree-info.html">← Previous</a></li>
      </ul>
    </div>



</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">



                   <address id="about" class="vcard body">
                       <br>
                       <nav class="widget">
                           <h4>推荐博客</h4>
                           <ul class="blank">
                               <li><a href="http://jm.taobao.org/">阿里中间件团队博客</a></li>
                               <li><a href="http://www.spring4all.com/">Spring中文社区</a></li>
                               <li><a href="https://github.com/alibaba">alibaba开源项目</a></li>
                               <li><a href="https://github.com/google">google开源项目</a></li>
                           </ul>
                       </nav>
                       <br/>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-119892182-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'nicky-chen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="/theme/js/libs/gumby.min.js"></script>
  <script src="/theme/js/plugins.js"></script>
  <script src="/theme/js/toc.js" type="text/javascript"></script>
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</body>
</html>